Cribbed from the Java agent
