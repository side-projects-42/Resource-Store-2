<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="fetch-event-source">Fetch Event Source</h1>
<p>This package provides a better API for making <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events">Event Source requests</a> - also known as server-sent events - with all the features available in the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a>.</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource">default browser EventSource API</a> imposes several restrictions on the type of request you’re allowed to make: the <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource/EventSource#Parameters">only parameters</a> you’re allowed to pass in are the <code>url</code> and <code>withCredentials</code>, so: * You cannot pass in a request body: you have to encode all the information necessary to execute the request inside the URL, which is <a href="https://stackoverflow.com/questions/417142">limited to 2000 characters</a> in most browsers. * You cannot pass in custom request headers * You can only make GET requests - there is no way to specify another method. * If the connection is cut, you don’t have any control over the retry strategy: the browser will silently retry for you a few times and then stop, which is not good enough for any sort of robust application.</p>
<p>This library provides an alternate interface for consuming server-sent events, based on the Fetch API. It is fully compatible with the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events#Event_stream_format">Event Stream format</a>, so if you already have a server emitting these events, you can consume it just like before. However, you now have greater control over the request and response so:</p>
<ul>
<li>You can use any request method/headers/body, plus all the other functionality exposed by fetch(). You can even provide an alternate fetch() implementation, if the default browser implementation doesn’t work for you.</li>
<li>You have access to the response object if you want to do some custom validation/processing before parsing the event source. This is useful in case you have API gateways (like nginx) in front of your application server: if the gateway returns an error, you might want to handle it correctly.</li>
<li>If the connection gets cut or an error occurs, you have full control over the retry strategy.</li>
</ul>
<p>In addition, this library also plugs into the browser’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API">Page Visibility API</a> so the connection closes if the document is hidden (e.g., the user minimizes the window), and automatically retries with the last event ID when it becomes visible again. This reduces the load on your server by not having open connections unnecessarily (but you can opt out of this behavior if you want.)</p>
<h1 id="install">Install</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">npm</span> install @microsoft/fetch-event-source</a></code></pre></div>
<h1 id="usage">Usage</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode ts"><code class="sourceCode typescript"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// BEFORE:</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">const</span> sse <span class="op">=</span> <span class="kw">new</span> <span class="bu">EventSource</span>(<span class="st">&#39;/api/sse&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="va">sse</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (ev) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="va">ev</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="op">};</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">// AFTER:</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="im">import</span> <span class="op">{</span> fetchEventSource <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;@microsoft/fetch-event-source&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-9" title="9"></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="cf">await</span> <span class="fu">fetchEventSource</span>(<span class="st">&#39;/api/sse&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-11" title="11">    <span class="fu">onmessage</span>(ev) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-12" title="12">        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="va">ev</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>You can pass in all the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch#Parameters">other parameters</a> exposed by the default fetch API, for example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ts"><code class="sourceCode typescript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">const</span> ctrl <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="fu">fetchEventSource</span>(<span class="st">&#39;/api/sse&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-3" title="3">    method<span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-4" title="4">    headers<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" title="5">        <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="op">},</span></a>
<a class="sourceLine" id="cb3-7" title="7">    body<span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb3-8" title="8">        foo<span class="op">:</span> <span class="st">&#39;bar&#39;</span></a>
<a class="sourceLine" id="cb3-9" title="9">    <span class="op">}</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb3-10" title="10">    signal<span class="op">:</span> <span class="va">ctrl</span><span class="op">.</span><span class="at">signal</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>You can add better error handling, for example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ts"><code class="sourceCode typescript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">class</span> RetriableError <span class="kw">extends</span> <span class="bu">Error</span> <span class="op">{</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">class</span> FatalError <span class="kw">extends</span> <span class="bu">Error</span> <span class="op">{</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="fu">fetchEventSource</span>(<span class="st">&#39;/api/sse&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="kw">async</span> <span class="fu">onopen</span>(response) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">        <span class="fu">if</span> (<span class="va">response</span><span class="op">.</span><span class="at">ok</span> <span class="op">&amp;&amp;</span> <span class="va">response</span><span class="op">.</span><span class="va">headers</span><span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;content-type&#39;</span>) <span class="op">===</span> EventStreamContentType) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-7" title="7">            <span class="cf">return</span><span class="op">;</span> <span class="co">// everything&#39;s good</span></a>
<a class="sourceLine" id="cb4-8" title="8">        <span class="op">}</span> <span class="cf">else</span> <span class="fu">if</span> (<span class="va">response</span><span class="op">.</span><span class="at">status</span> <span class="op">&gt;=</span> <span class="dv">400</span> <span class="op">&amp;&amp;</span> <span class="va">response</span><span class="op">.</span><span class="at">status</span> <span class="op">&lt;</span> <span class="dv">500</span> <span class="op">&amp;&amp;</span> <span class="va">response</span><span class="op">.</span><span class="at">status</span> <span class="op">!==</span> <span class="dv">429</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-9" title="9">            <span class="co">// client-side errors are usually non-retriable:</span></a>
<a class="sourceLine" id="cb4-10" title="10">            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">FatalError</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-11" title="11">        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-12" title="12">            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">RetriableError</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-13" title="13">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="op">},</span></a>
<a class="sourceLine" id="cb4-15" title="15">    <span class="fu">onmessage</span>(msg) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-16" title="16">        <span class="co">// if the server emits an error message, throw an exception</span></a>
<a class="sourceLine" id="cb4-17" title="17">        <span class="co">// so it gets handled by the onerror callback below:</span></a>
<a class="sourceLine" id="cb4-18" title="18">        <span class="fu">if</span> (<span class="va">msg</span><span class="op">.</span><span class="at">event</span> <span class="op">===</span> <span class="st">&#39;FatalError&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-19" title="19">            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">FatalError</span>(<span class="va">msg</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-20" title="20">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-21" title="21">    <span class="op">},</span></a>
<a class="sourceLine" id="cb4-22" title="22">    <span class="fu">onclose</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb4-23" title="23">        <span class="co">// if the server closes the connection unexpectedly, retry:</span></a>
<a class="sourceLine" id="cb4-24" title="24">        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">RetriableError</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb4-25" title="25">    <span class="op">},</span></a>
<a class="sourceLine" id="cb4-26" title="26">    <span class="fu">onerror</span>(err) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-27" title="27">        <span class="fu">if</span> (err <span class="kw">instanceof</span> FatalError) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-28" title="28">            <span class="cf">throw</span> err<span class="op">;</span> <span class="co">// rethrow to stop the operation</span></a>
<a class="sourceLine" id="cb4-29" title="29">        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-30" title="30">            <span class="co">// do nothing to automatically retry. You can also</span></a>
<a class="sourceLine" id="cb4-31" title="31">            <span class="co">// return a specific retry interval here.</span></a>
<a class="sourceLine" id="cb4-32" title="32">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-33" title="33">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-34" title="34"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h1 id="compatibility">Compatibility</h1>
<p>This library is written in typescript and targets ES2017 features supported by all evergreen browsers (Chrome, Firefox, Safari, Edge.) You might need to <a href="https://www.npmjs.com/package/fast-text-encoding">polyfill TextDecoder</a> for old Edge (versions &lt; 79), though:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="at">require</span>(<span class="st">&#39;fast-text-encoding&#39;</span>)<span class="op">;</span></a></code></pre></div>
<h1 id="contributing">Contributing</h1>
<p>This project welcomes contributions and suggestions. Most contributions require you to agree to a Contributor License Agreement (CLA) declaring that you have the right to, and actually do, grant us the rights to use your contribution. For details, visit https://cla.opensource.microsoft.com.</p>
<p>When you submit a pull request, a CLA bot will automatically determine whether you need to provide a CLA and decorate the PR appropriately (e.g., status check, comment). Simply follow the instructions provided by the bot. You will only need to do this once across all repos using our CLA.</p>
<p>This project has adopted the <a href="https://opensource.microsoft.com/codeofconduct/">Microsoft Open Source Code of Conduct</a>. For more information see the <a href="https://opensource.microsoft.com/codeofconduct/faq/">Code of Conduct FAQ</a> or contact <a href="mailto:opencode@microsoft.com">opencode@microsoft.com</a> with any additional questions or comments.</p>
</body>
</html>
