<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="proper-lockfile">proper-lockfile</h1>
<p><a href="https://npmjs.org/package/proper-lockfile"><img src="https://img.shields.io/npm/v/proper-lockfile.svg" alt="NPM version" /></a> <a href="https://npmjs.org/package/proper-lockfile"><img src="https://img.shields.io/npm/dm/proper-lockfile.svg" alt="Downloads" /></a> <a href="https://travis-ci.org/moxystudio/node-proper-lockfile"><img src="https://img.shields.io/travis/moxystudio/node-proper-lockfile/master.svg" alt="Build Status" /></a> <a href="https://codecov.io/gh/moxystudio/node-proper-lockfile"><img src="https://img.shields.io/codecov/c/github/moxystudio/node-proper-lockfile/master.svg" alt="Coverage Status" /></a> <a href="https://david-dm.org/moxystudio/node-proper-lockfile"><img src="https://img.shields.io/david/moxystudio/node-proper-lockfile.svg" alt="Dependency status" /></a> <a href="https://david-dm.org/moxystudio/node-proper-lockfile?type=dev"><img src="https://img.shields.io/david/dev/moxystudio/node-proper-lockfile.svg" alt="Dev Dependency status" /></a></p>
<p>An inter-process and inter-machine lockfile utility that works on a local or network file system.</p>
<h2 id="installation">Installation</h2>
<p><code>$ npm install proper-lockfile</code></p>
<h2 id="design">Design</h2>
<p>There are various ways to achieve <a href="http://en.wikipedia.org/wiki/File_locking">file locking</a>.</p>
<p>This library utilizes the <code>mkdir</code> strategy which works atomically on any kind of file system, even network based ones. The lockfile path is based on the file path you are trying to lock by suffixing it with <code>.lock</code>.</p>
<p>When a lock is successfully acquired, the lockfile’s <code>mtime</code> (modified time) is periodically updated to prevent staleness. This allows to effectively check if a lock is stale by checking its <code>mtime</code> against a stale threshold. If the update of the mtime fails several times, the lock might be compromised. The <code>mtime</code> is <a href="http://en.wikipedia.org/wiki/Comparison_of_file_systems">supported</a> in almost every <code>filesystem</code>.</p>
<h3 id="comparison">Comparison</h3>
<p>This library is similar to <a href="https://github.com/isaacs/lockfile">lockfile</a> but the latter has some drawbacks:</p>
<ul>
<li>It relies on <code>open</code> with <code>O_EXCL</code> flag which has problems in network file systems. <code>proper-lockfile</code> uses <code>mkdir</code> which doesn’t have this issue.</li>
</ul>
<blockquote>
<p>O_EXCL is broken on NFS file systems; programs which rely on it for performing locking tasks will contain a race condition.</p>
</blockquote>
<ul>
<li><p>The lockfile staleness check is done via <code>ctime</code> (creation time) which is unsuitable for long running processes. <code>proper-lockfile</code> constantly updates lockfiles <code>mtime</code> to do proper staleness check.</p></li>
<li><p>It does not check if the lockfile was compromised which can lead to undesirable situations. <code>proper-lockfile</code> checks the lockfile when updating the <code>mtime</code>.</p></li>
<li><p>It has a default value of <code>0</code> for the stale option which isn’t good because any crash or process kill that the package can’t handle gracefully will leave the lock active forever.</p></li>
</ul>
<h3 id="compromised">Compromised</h3>
<p><code>proper-lockfile</code> does not detect cases in which:</p>
<ul>
<li>A <code>lockfile</code> is manually removed and someone else acquires the lock right after</li>
<li>Different <code>stale</code>/<code>update</code> values are being used for the same file, possibly causing two locks to be acquired on the same file</li>
</ul>
<p><code>proper-lockfile</code> detects cases in which:</p>
<ul>
<li>Updates to the <code>lockfile</code> fail</li>
<li>Updates take longer than expected, possibly causing the lock to become stale for a certain amount of time</li>
</ul>
<p>As you see, the first two are a consequence of bad usage. Technically, it was possible to detect the first two but it would introduce complexity and eventual race conditions.</p>
<h2 id="usage">Usage</h2>
<h3 id="lockfile-options">.lock(file, [options])</h3>
<p>Tries to acquire a lock on <code>file</code> or rejects the promise on error.</p>
<p>If the lock succeeds, a <code>release</code> function is provided that should be called when you want to release the lock. The <code>release</code> function also rejects the promise on error (e.g. when the lock was already compromised).</p>
<p>Available options:</p>
<ul>
<li><code>stale</code>: Duration in milliseconds in which the lock is considered stale, defaults to <code>10000</code> (minimum value is <code>5000</code>)</li>
<li><code>update</code>: The interval in milliseconds in which the lockfile’s <code>mtime</code> will be updated, defaults to <code>stale/2</code> (minimum value is <code>1000</code>, maximum value is <code>stale/2</code>)</li>
<li><code>retries</code>: The number of retries or a <a href="https://www.npmjs.org/package/retry">retry</a> options object, defaults to <code>0</code></li>
<li><code>realpath</code>: Resolve symlinks using realpath, defaults to <code>true</code> (note that if <code>true</code>, the <code>file</code> must exist previously)</li>
<li><code>fs</code>: A custom fs to use, defaults to <code>graceful-fs</code></li>
<li><code>onCompromised</code>: Called if the lock gets compromised, defaults to a function that simply throws the error which will probably cause the process to die</li>
<li><code>lockfilePath</code>: Custom lockfile path. e.g.: If you want to lock a directory and create the lock file inside it, you can pass <code>file</code> as <code>&lt;dir path&gt;</code> and <code>options.lockfilePath</code> as <code>&lt;dir path&gt;/dir.lock</code></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">const</span> lockfile <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;proper-lockfile&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="va">lockfile</span>.<span class="at">lock</span>(<span class="st">&#39;some/file&#39;</span>)</a>
<a class="sourceLine" id="cb1-4" title="4">.<span class="at">then</span>((release) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">    <span class="co">// Do something while the file is locked</span></a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="co">// Call the provided release function when you&#39;re done,</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="co">// which will also return a promise</span></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="cf">return</span> <span class="at">release</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb1-11" title="11">.<span class="at">catch</span>((e) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="co">// either lock could not be acquired</span></a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="co">// or releasing it failed</span></a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="va">console</span>.<span class="at">error</span>(e)</a>
<a class="sourceLine" id="cb1-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-16" title="16"></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="co">// Alternatively, you may use lockfile(&#39;some/file&#39;) directly.</span></a></code></pre></div>
<h3 id="unlockfile-options">.unlock(file, [options])</h3>
<p>Releases a previously acquired lock on <code>file</code> or rejects the promise on error.</p>
<p>Whenever possible you should use the <code>release</code> function instead (as exemplified above). Still there are cases in which it’s hard to keep a reference to it around code. In those cases <code>unlock()</code> might be handy.</p>
<p>Available options:</p>
<ul>
<li><code>realpath</code>: Resolve symlinks using realpath, defaults to <code>true</code> (note that if <code>true</code>, the <code>file</code> must exist previously)</li>
<li><code>fs</code>: A custom fs to use, defaults to <code>graceful-fs</code></li>
<li><code>lockfilePath</code>: Custom lockfile path. e.g.: If you want to lock a directory and create the lock file inside it, you can pass <code>file</code> as <code>&lt;dir path&gt;</code> and <code>options.lockfilePath</code> as <code>&lt;dir path&gt;/dir.lock</code></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">const</span> lockfile <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;proper-lockfile&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="va">lockfile</span>.<span class="at">lock</span>(<span class="st">&#39;some/file&#39;</span>)</a>
<a class="sourceLine" id="cb2-4" title="4">.<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="co">// Do something while the file is locked</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="co">// Later..</span></a>
<a class="sourceLine" id="cb2-8" title="8">    <span class="cf">return</span> <span class="va">lockfile</span>.<span class="at">unlock</span>(<span class="st">&#39;some/file&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h3 id="checkfile-options">.check(file, [options])</h3>
<p>Check if the file is locked and its lockfile is not stale, rejects the promise on error.</p>
<p>Available options:</p>
<ul>
<li><code>stale</code>: Duration in milliseconds in which the lock is considered stale, defaults to <code>10000</code> (minimum value is <code>5000</code>)</li>
<li><code>realpath</code>: Resolve symlinks using realpath, defaults to <code>true</code> (note that if <code>true</code>, the <code>file</code> must exist previously)</li>
<li><code>fs</code>: A custom fs to use, defaults to <code>graceful-fs</code></li>
<li><code>lockfilePath</code>: Custom lockfile path. e.g.: If you want to lock a directory and create the lock file inside it, you can pass <code>file</code> as <code>&lt;dir path&gt;</code> and <code>options.lockfilePath</code> as <code>&lt;dir path&gt;/dir.lock</code></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">const</span> lockfile <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;proper-lockfile&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="va">lockfile</span>.<span class="at">check</span>(<span class="st">&#39;some/file&#39;</span>)</a>
<a class="sourceLine" id="cb3-4" title="4">.<span class="at">then</span>((isLocked) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="co">// isLocked will be true if &#39;some/file&#39; is locked, false otherwise</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h3 id="locksyncfile-options">.lockSync(file, [options])</h3>
<p>Sync version of <code>.lock()</code>.<br />
Returns the <code>release</code> function or throws on error.</p>
<h3 id="unlocksyncfile-options">.unlockSync(file, [options])</h3>
<p>Sync version of <code>.unlock()</code>.<br />
Throws on error.</p>
<h3 id="checksyncfile-options">.checkSync(file, [options])</h3>
<p>Sync version of <code>.check()</code>. Returns a boolean or throws on error.</p>
<h2 id="graceful-exit">Graceful exit</h2>
<p><code>proper-lockfile</code> automatically removes locks if the process exits, except if the process is killed with SIGKILL or it crashes due to a VM fatal error (e.g.: out of memory).</p>
<h2 id="tests">Tests</h2>
<p><code>$ npm test</code><br />
<code>$ npm test -- --watch</code> during development</p>
<p>The test suite is very extensive. There’s even a stress test to guarantee exclusiveness of locks.</p>
<h2 id="license">License</h2>
<p>Released under the <a href="https://www.opensource.org/licenses/mit-license.php">MIT License</a>.</p>
</body>
</html>
