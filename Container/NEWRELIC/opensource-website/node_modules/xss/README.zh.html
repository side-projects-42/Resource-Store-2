<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README.zh</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<p><a href="https://npmjs.org/package/xss"><img src="https://img.shields.io/npm/v/xss.svg?style=flat-square" alt="NPM version" /></a> <a href="https://github.com/leizongmin/js-xss/actions/workflows/nodejs.yml"><img src="https://github.com/leizongmin/js-xss/actions/workflows/nodejs.yml/badge.svg" alt="Node.js CI" /></a> <a href="https://coveralls.io/r/leizongmin/js-xss?branch=master"><img src="https://img.shields.io/coveralls/leizongmin/js-xss.svg?style=flat-square" alt="Test coverage" /></a> <a href="https://david-dm.org/leizongmin/js-xss"><img src="https://img.shields.io/david/leizongmin/js-xss.svg?style=flat-square" alt="David deps" /></a> <a href="http://nodejs.org/download/"><img src="https://img.shields.io/badge/node.js-%3E=_0.10-green.svg?style=flat-square" alt="node version" /></a> <a href="https://npmjs.org/package/xss"><img src="https://img.shields.io/npm/dm/xss.svg?style=flat-square" alt="npm download" /></a> <a href="https://npmjs.org/package/xss"><img src="https://img.shields.io/npm/l/xss.svg" alt="npm license" /></a></p>
<h1 id="根据白名单过滤-html防止-xss-攻击">根据白名单过滤 HTML(防止 XSS 攻击)</h1>
<figure>
<img src="https://nodei.co/npm/xss.png?downloads=true&amp;stars=true" alt="xss" /><figcaption>xss</figcaption>
</figure>
<hr />
<p><code>xss</code>是一个用于对用户输入的内容进行过滤，以避免遭受 XSS 攻击的模块（<a href="http://baike.baidu.com/view/2161269.htm">什么是 XSS 攻击？</a>）。主要用于论坛、博客、网上商店等等一些可允许用户录入页面排版、格式控制相关的 HTML 的场景，<code>xss</code>模块通过白名单来控制允许的标签及相关的标签属性，另外还提供了一系列的接口以便用户扩展，比其他同类模块更为灵活。</p>
<p><strong>项目主页：</strong> http://jsxss.com</p>
<p><strong>在线测试：</strong> http://jsxss.com/zh/try.html</p>
<hr />
<h2 id="特性">特性</h2>
<ul>
<li>白名单控制允许的 HTML 标签及各标签的属性</li>
<li>通过自定义处理函数，可对任意标签及其属性进行处理</li>
</ul>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="http://drops.wooyun.org/tips/689">XSS 与字符编码的那些事儿 —科普文</a></li>
<li><a href="http://www.wooyun.org/whitehats/%E5%BF%83%E4%BC%A4%E7%9A%84%E7%98%A6%E5%AD%90">腾讯实例教程：那些年我们一起学 XSS</a></li>
<li><a href="http://drops.wooyun.org/tips/956">mXSS 攻击的成因及常见种类</a></li>
<li><a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet">XSS Filter Evasion Cheat Sheet</a></li>
<li><a href="http://en.wikipedia.org/wiki/Data_URI_scheme">Data URI scheme</a></li>
<li><a href="http://hi.baidu.com/badzzzz/item/bdbafe83144619c199255f7b">XSS with Data URI Scheme</a></li>
</ul>
<h2 id="性能仅作参考">性能（仅作参考）</h2>
<ul>
<li>xss 模块：22.53 MB/s</li>
<li>validator@0.3.7 模块的 xss()函数：6.9 MB/s</li>
</ul>
<p>测试代码参考 benchmark 目录</p>
<h2 id="安装">安装</h2>
<h3 id="npm">NPM</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">npm</span> install xss</a></code></pre></div>
<h3 id="bower">Bower</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="ex">bower</span> install xss</a></code></pre></div>
<p>或者</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="ex">bower</span> install https://github.com/leizongmin/js-xss.git</a></code></pre></div>
<h2 id="使用方法">使用方法</h2>
<h3 id="在-node.js-中使用">在 Node.js 中使用</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">var</span> xss <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;xss&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">var</span> html <span class="op">=</span> <span class="at">xss</span>(<span class="st">&#39;&lt;script&gt;alert(&quot;xss&quot;);&lt;/script&gt;&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="va">console</span>.<span class="at">log</span>(html)<span class="op">;</span></a></code></pre></div>
<h3 id="在浏览器端使用">在浏览器端使用</h3>
<p>Shim 模式（参考文件 <code>test/test.html</code>）:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;https://rawgit.com/leizongmin/js-xss/master/dist/xss.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">&lt;script&gt;</span></a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="co">// 使用函数名 filterXSS，用法一样</span></a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="kw">var</span> html <span class="op">=</span> <span class="at">filterXSS</span>(<span class="st">&#39;&lt;script&gt;alert(&quot;xss&quot;);&lt;/scr&#39;</span> <span class="op">+</span> <span class="st">&quot;ipt&gt;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="at">alert</span>(html)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="kw">&lt;/script&gt;</span></a></code></pre></div>
<p>AMD 模式（参考文件 <code>test/test_amd.html</code>）:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">&lt;script&gt;</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="va">require</span>.<span class="at">config</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="dt">baseUrl</span><span class="op">:</span> <span class="st">&quot;./&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="dt">paths</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-5" title="5">      <span class="dt">xss</span><span class="op">:</span> <span class="st">&quot;https://rawgit.com/leizongmin/js-xss/master/dist/xss.js&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="op">},</span></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="dt">shim</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-8" title="8">      <span class="dt">xss</span><span class="op">:</span> <span class="op">{</span> <span class="dt">exports</span><span class="op">:</span> <span class="st">&quot;filterXSS&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb6-9" title="9">    <span class="op">},</span></a>
<a class="sourceLine" id="cb6-10" title="10">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-11" title="11">  <span class="at">require</span>([<span class="st">&quot;xss&quot;</span>]<span class="op">,</span> <span class="kw">function</span> (xss) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-12" title="12">    <span class="kw">var</span> html <span class="op">=</span> <span class="at">xss</span>(<span class="st">&#39;&lt;script&gt;alert(&quot;xss&quot;);&lt;/scr&#39;</span> <span class="op">+</span> <span class="st">&quot;ipt&gt;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-13" title="13">    <span class="at">alert</span>(html)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-14" title="14">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="kw">&lt;/script&gt;</span></a></code></pre></div>
<p><strong>说明：请勿将 URL https://rawgit.com/leizongmin/js-xss/master/dist/xss.js 用于生产环境。</strong></p>
<h3 id="使用命令行工具来对文件进行-xss-处理">使用命令行工具来对文件进行 XSS 处理</h3>
<h3 id="处理文件">处理文件</h3>
<p>可通过内置的 <code>xss</code> 命令来对输入的文件进行 XSS 处理。使用方法：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="ex">xss</span> -i <span class="op">&lt;</span>源文件<span class="op">&gt;</span> -o <span class="op">&lt;</span>目标文件<span class="op">&gt;</span></a></code></pre></div>
<p>例：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="ex">xss</span> -i origin.html -o target.html</a></code></pre></div>
<h3 id="在线测试">在线测试</h3>
<p>执行以下命令，可在命令行中输入 HTML 代码，并看到过滤后的代码：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="ex">xss</span> -t</a></code></pre></div>
<p>详细命令行参数说明，请输入 <code>$ xss -h</code> 来查看。</p>
<h2 id="自定义过滤规则">自定义过滤规则</h2>
<p>在调用 <code>xss()</code> 函数进行过滤时，可通过第二个参数来设置自定义规则：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1">options <span class="op">=</span> <span class="op">{};</span> <span class="co">// 自定义规则</span></a>
<a class="sourceLine" id="cb10-2" title="2">html <span class="op">=</span> <span class="at">xss</span>(<span class="st">&#39;&lt;script&gt;alert(&quot;xss&quot;);&lt;/script&gt;&#39;</span><span class="op">,</span> options)<span class="op">;</span></a></code></pre></div>
<p>如果不想每次都传入一个 <code>options</code> 参数，可以创建一个 <code>FilterXSS</code> 实例（使用这种方法速度更快）：</p>
<pre><code>options = {};  // 自定义规则
myxss = new xss.FilterXSS(options);
// 以后直接调用 myxss.process() 来处理即可
html = myxss.process(&#39;&lt;script&gt;alert(&quot;xss&quot;);&lt;/script&gt;&#39;);</code></pre>
<p><code>options</code> 参数的详细说明见下文。</p>
<h3 id="白名单">白名单</h3>
<p>通过 <code>whiteList</code> 来指定，格式为：<code>{'标签名': ['属性1', '属性2']}</code>。不在白名单上的标签将被过滤，不在白名单上的属性也会被过滤。以下是示例：</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="co">// 只允许a标签，该标签只允许href, title, target这三个属性</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="kw">var</span> options <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="dt">whiteList</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="dt">a</span><span class="op">:</span> [<span class="st">&quot;href&quot;</span><span class="op">,</span> <span class="st">&quot;title&quot;</span><span class="op">,</span> <span class="st">&quot;target&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="op">},</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="op">};</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co">// 使用以上配置后，下面的HTML</span></a>
<a class="sourceLine" id="cb12-8" title="8"><span class="co">// &lt;a href=&quot;#&quot; onclick=&quot;hello()&quot;&gt;&lt;i&gt;大家好&lt;/i&gt;&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="co">// 将被过滤为</span></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="co">// &lt;a href=&quot;#&quot;&gt;大家好&lt;/a&gt;</span></a></code></pre></div>
<p>默认白名单参考 <code>xss.whiteList</code>。</p>
<h3 id="自定义匹配到标签时的处理方法">自定义匹配到标签时的处理方法</h3>
<p>通过 <code>onTag</code> 来指定相应的处理函数。以下是详细说明：</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">function</span> <span class="at">onTag</span>(tag<span class="op">,</span> html<span class="op">,</span> options) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="co">// tag是当前的标签名称，比如&lt;a&gt;标签，则tag的值是&#39;a&#39;</span></a>
<a class="sourceLine" id="cb13-3" title="3">  <span class="co">// html是该标签的HTML，比如&lt;a&gt;标签，则html的值是&#39;&lt;a&gt;&#39;</span></a>
<a class="sourceLine" id="cb13-4" title="4">  <span class="co">// options是一些附加的信息，具体如下：</span></a>
<a class="sourceLine" id="cb13-5" title="5">  <span class="co">//   isWhite    boolean类型，表示该标签是否在白名单上</span></a>
<a class="sourceLine" id="cb13-6" title="6">  <span class="co">//   isClosing  boolean类型，表示该标签是否为闭合标签，比如&lt;/a&gt;时为true</span></a>
<a class="sourceLine" id="cb13-7" title="7">  <span class="co">//   position        integer类型，表示当前标签在输出的结果中的起始位置</span></a>
<a class="sourceLine" id="cb13-8" title="8">  <span class="co">//   sourcePosition  integer类型，表示当前标签在原HTML中的起始位置</span></a>
<a class="sourceLine" id="cb13-9" title="9">  <span class="co">// 如果返回一个字符串，则当前标签将被替换为该字符串</span></a>
<a class="sourceLine" id="cb13-10" title="10">  <span class="co">// 如果不返回任何值，则使用默认的处理方法：</span></a>
<a class="sourceLine" id="cb13-11" title="11">  <span class="co">//   在白名单上：  通过onTagAttr来过滤属性，详见下文</span></a>
<a class="sourceLine" id="cb13-12" title="12">  <span class="co">//   不在白名单上：通过onIgnoreTag指定，详见下文</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="op">}</span></a></code></pre></div>
<h3 id="自定义匹配到标签的属性时的处理方法">自定义匹配到标签的属性时的处理方法</h3>
<p>通过 <code>onTagAttr</code> 来指定相应的处理函数。以下是详细说明：</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">function</span> <span class="at">onTagAttr</span>(tag<span class="op">,</span> name<span class="op">,</span> value<span class="op">,</span> isWhiteAttr) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="co">// tag是当前的标签名称，比如&lt;a&gt;标签，则tag的值是&#39;a&#39;</span></a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="co">// name是当前属性的名称，比如href=&quot;#&quot;，则name的值是&#39;href&#39;</span></a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="co">// value是当前属性的值，比如href=&quot;#&quot;，则value的值是&#39;#&#39;</span></a>
<a class="sourceLine" id="cb14-5" title="5">  <span class="co">// isWhiteAttr是否为白名单上的属性</span></a>
<a class="sourceLine" id="cb14-6" title="6">  <span class="co">// 如果返回一个字符串，则当前属性值将被替换为该字符串</span></a>
<a class="sourceLine" id="cb14-7" title="7">  <span class="co">// 如果不返回任何值，则使用默认的处理方法</span></a>
<a class="sourceLine" id="cb14-8" title="8">  <span class="co">//   在白名单上：  调用safeAttrValue来过滤属性值，并输出该属性，详见下文</span></a>
<a class="sourceLine" id="cb14-9" title="9">  <span class="co">//   不在白名单上：通过onIgnoreTagAttr指定，详见下文</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="op">}</span></a></code></pre></div>
<h3 id="自定义匹配到不在白名单上的标签时的处理方法">自定义匹配到不在白名单上的标签时的处理方法</h3>
<p>通过 <code>onIgnoreTag</code> 来指定相应的处理函数。以下是详细说明：</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">function</span> <span class="at">onIgnoreTag</span>(tag<span class="op">,</span> html<span class="op">,</span> options) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="co">// 参数说明与onTag相同</span></a>
<a class="sourceLine" id="cb15-3" title="3">  <span class="co">// 如果返回一个字符串，则当前标签将被替换为该字符串</span></a>
<a class="sourceLine" id="cb15-4" title="4">  <span class="co">// 如果不返回任何值，则使用默认的处理方法（通过escape指定，详见下文）</span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="op">}</span></a></code></pre></div>
<h3 id="自定义匹配到不在白名单上的属性时的处理方法">自定义匹配到不在白名单上的属性时的处理方法</h3>
<p>通过 <code>onIgnoreTagAttr</code> 来指定相应的处理函数。以下是详细说明：</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">function</span> <span class="at">onIgnoreTagAttr</span>(tag<span class="op">,</span> name<span class="op">,</span> value<span class="op">,</span> isWhiteAttr) <span class="op">{</span></a>
<a class="sourceLine" id="cb16-2" title="2">  <span class="co">// 参数说明与onTagAttr相同</span></a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="co">// 如果返回一个字符串，则当前属性值将被替换为该字符串</span></a>
<a class="sourceLine" id="cb16-4" title="4">  <span class="co">// 如果不返回任何值，则使用默认的处理方法（删除该属）</span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="op">}</span></a></code></pre></div>
<h3 id="自定义-html-转义函数">自定义 HTML 转义函数</h3>
<p>通过 <code>escapeHtml</code> 来指定相应的处理函数。以下是默认代码 <strong>（不建议修改）</strong> ：</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">function</span> <span class="at">escapeHtml</span>(html) <span class="op">{</span></a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="cf">return</span> <span class="va">html</span>.<span class="at">replace</span>(<span class="ss">/&lt;/g</span><span class="op">,</span> <span class="st">&quot;&amp;lt;&quot;</span>).<span class="at">replace</span>(/&gt;/g<span class="op">,</span> <span class="st">&quot;&amp;gt;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="op">}</span></a></code></pre></div>
<h3 id="自定义标签属性值的转义函数">自定义标签属性值的转义函数</h3>
<p>通过 <code>safeAttrValue</code> 来指定相应的处理函数。以下是详细说明：</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">function</span> <span class="at">safeAttrValue</span>(tag<span class="op">,</span> name<span class="op">,</span> value) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="co">// 参数说明与onTagAttr相同（没有options参数）</span></a>
<a class="sourceLine" id="cb18-3" title="3">  <span class="co">// 返回一个字符串表示该属性值</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="op">}</span></a></code></pre></div>
<h3 id="自定义-css-过滤器">自定义 CSS 过滤器</h3>
<p>如果配置中允许了标签的 <code>style</code> 属性，则它的值会通过<a href="https://github.com/leizongmin/js-css-filter">cssfilter</a> 模块处理。 <code>cssfilter</code> 模块包含了一个默认的 CSS 白名单，你可以通过以下的方式配置：</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" title="1">myxss <span class="op">=</span> <span class="kw">new</span> <span class="va">xss</span>.<span class="at">FilterXSS</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="dt">css</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-3" title="3">    <span class="dt">whiteList</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-4" title="4">      <span class="dt">position</span><span class="op">:</span> <span class="ss">/</span><span class="sc">^</span><span class="ss">fixed</span><span class="sc">|</span><span class="ss">relative</span><span class="sc">$</span><span class="ss">/</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-5" title="5">      <span class="dt">top</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-6" title="6">      <span class="dt">left</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb19-7" title="7">    <span class="op">},</span></a>
<a class="sourceLine" id="cb19-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-10" title="10">html <span class="op">=</span> <span class="va">myxss</span>.<span class="at">process</span>(<span class="st">&#39;&lt;script&gt;alert(&quot;xss&quot;);&lt;/script&gt;&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>如果不想使用 CSS 过滤器来处理 <code>style</code> 属性的内容，可指定 <code>css</code> 选项的值为 <code>false</code>：</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb20-1" title="1">myxss <span class="op">=</span> <span class="kw">new</span> <span class="va">xss</span>.<span class="at">FilterXSS</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb20-2" title="2">  <span class="dt">css</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>要获取更多的帮助信息可看这里：https://github.com/leizongmin/js-css-filter</p>
<h3 id="快捷配置">快捷配置</h3>
<h4 id="去掉不在白名单上的标签">去掉不在白名单上的标签</h4>
<p>通过 <code>stripIgnoreTag</code> 来设置：</p>
<ul>
<li><code>true</code>：去掉不在白名单上的标签</li>
<li><code>false</code>：（默认），使用配置的<code>escape</code>函数对该标签进行转义</li>
</ul>
<p>示例：</p>
<p>当设置 <code>stripIgnoreTag = true</code>时，以下代码</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb21-1" title="1">code:</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="kw">&lt;script&gt;</span></a>
<a class="sourceLine" id="cb21-3" title="3">  <span class="at">alert</span>(<span class="ss">/xss/</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="kw">&lt;/script&gt;</span></a></code></pre></div>
<p>过滤后将输出</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb22-1" title="1">code:alert(/xss/);</a></code></pre></div>
<h4 id="去掉不在白名单上的标签及标签体">去掉不在白名单上的标签及标签体</h4>
<p>通过 <code>stripIgnoreTagBody</code> 来设置：</p>
<ul>
<li><code>false|null|undefined</code>：（默认），不特殊处理</li>
<li><code>'*'|true</code>：去掉所有不在白名单上的标签</li>
<li><code>['tag1', 'tag2']</code>：仅去掉指定的不在白名单上的标签</li>
</ul>
<p>示例：</p>
<p>当设置 <code>stripIgnoreTagBody = ['script']</code>时，以下代码</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb23-1" title="1">code:</a>
<a class="sourceLine" id="cb23-2" title="2"><span class="kw">&lt;script&gt;</span></a>
<a class="sourceLine" id="cb23-3" title="3">  <span class="at">alert</span>(<span class="ss">/xss/</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="kw">&lt;/script&gt;</span></a></code></pre></div>
<p>过滤后将输出</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb24-1" title="1">code:</a></code></pre></div>
<h4 id="去掉-html-备注">去掉 HTML 备注</h4>
<p>通过 <code>allowCommentTag</code> 来设置：</p>
<ul>
<li><code>true</code>：不处理</li>
<li><code>false</code>：（默认），自动去掉 HTML 中的备注</li>
</ul>
<p>示例：</p>
<p>当设置 <code>allowCommentTag = false</code> 时，以下代码</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb25-1" title="1">code:<span class="co">&lt;!-- something --&gt;</span></a>
<a class="sourceLine" id="cb25-2" title="2">END</a></code></pre></div>
<p>过滤后将输出</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb26-1" title="1">code: END</a></code></pre></div>
<h2 id="应用实例">应用实例</h2>
<h3 id="允许标签以-data-开头的属性">允许标签以 data-开头的属性</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">var</span> source <span class="op">=</span> <span class="st">&#39;&lt;div a=&quot;1&quot; b=&quot;2&quot; data-a=&quot;3&quot; data-b=&quot;4&quot;&gt;hello&lt;/div&gt;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb27-2" title="2"><span class="kw">var</span> html <span class="op">=</span> <span class="at">xss</span>(source<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb27-3" title="3">  <span class="dt">onIgnoreTagAttr</span><span class="op">:</span> <span class="kw">function</span> (tag<span class="op">,</span> name<span class="op">,</span> value<span class="op">,</span> isWhiteAttr) <span class="op">{</span></a>
<a class="sourceLine" id="cb27-4" title="4">    <span class="cf">if</span> (<span class="va">name</span>.<span class="at">substr</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>) <span class="op">===</span> <span class="st">&quot;data-&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb27-5" title="5">      <span class="co">// 通过内置的escapeAttrValue函数来对属性值进行转义</span></a>
<a class="sourceLine" id="cb27-6" title="6">      <span class="cf">return</span> name <span class="op">+</span> <span class="st">&#39;=&quot;&#39;</span> <span class="op">+</span> <span class="va">xss</span>.<span class="at">escapeAttrValue</span>(value) <span class="op">+</span> <span class="st">&#39;&quot;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb27-7" title="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb27-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb27-9" title="9"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb27-10" title="10"></a>
<a class="sourceLine" id="cb27-11" title="11"><span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">convert to:</span><span class="sc">\n</span><span class="st">%s&quot;</span><span class="op">,</span> source<span class="op">,</span> html)<span class="op">;</span></a></code></pre></div>
<p>运行结果：</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">&lt;div</span><span class="ot"> a=</span><span class="st">&quot;1&quot;</span><span class="ot"> b=</span><span class="st">&quot;2&quot;</span><span class="ot"> data-a=</span><span class="st">&quot;3&quot;</span><span class="ot"> data-b=</span><span class="st">&quot;4&quot;</span><span class="kw">&gt;</span>hello<span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb28-2" title="2">convert to:</a>
<a class="sourceLine" id="cb28-3" title="3"><span class="kw">&lt;div</span><span class="ot"> data-a=</span><span class="st">&quot;3&quot;</span><span class="ot"> data-b=</span><span class="st">&quot;4&quot;</span><span class="kw">&gt;</span>hello<span class="kw">&lt;/div&gt;</span></a></code></pre></div>
<h3 id="允许名称以-x-开头的标签">允许名称以 x-开头的标签</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb29-1" title="1"><span class="kw">var</span> source <span class="op">=</span> <span class="st">&quot;&lt;x&gt;&lt;x-1&gt;he&lt;x-2 checked&gt;&lt;/x-2&gt;wwww&lt;/x-1&gt;&lt;a&gt;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-2" title="2"><span class="kw">var</span> html <span class="op">=</span> <span class="at">xss</span>(source<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-3" title="3">  <span class="dt">onIgnoreTag</span><span class="op">:</span> <span class="kw">function</span> (tag<span class="op">,</span> html<span class="op">,</span> options) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-4" title="4">    <span class="cf">if</span> (<span class="va">tag</span>.<span class="at">substr</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">2</span>) <span class="op">===</span> <span class="st">&quot;x-&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-5" title="5">      <span class="co">// 不对其属性列表进行过滤</span></a>
<a class="sourceLine" id="cb29-6" title="6">      <span class="cf">return</span> html<span class="op">;</span></a>
<a class="sourceLine" id="cb29-7" title="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb29-9" title="9"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-10" title="10"></a>
<a class="sourceLine" id="cb29-11" title="11"><span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">convert to:</span><span class="sc">\n</span><span class="st">%s&quot;</span><span class="op">,</span> source<span class="op">,</span> html)<span class="op">;</span></a></code></pre></div>
<p>运行结果：</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb30-1" title="1"><span class="kw">&lt;x</span></a>
<a class="sourceLine" id="cb30-2" title="2">  <span class="kw">&gt;&lt;x-1&gt;</span>he<span class="kw">&lt;x-2</span><span class="ot"> checked</span><span class="kw">&gt;&lt;/x-2&gt;</span>wwww<span class="kw">&lt;/x-1</span></a>
<a class="sourceLine" id="cb30-3" title="3">  <span class="kw">&gt;&lt;a&gt;</span></a>
<a class="sourceLine" id="cb30-4" title="4">    convert to: <span class="dv">&amp;lt;</span>x<span class="dv">&amp;gt;</span><span class="kw">&lt;x-1&gt;</span>he<span class="kw">&lt;x-2</span><span class="ot"> checked</span><span class="kw">&gt;&lt;/x-2&gt;</span>wwww<span class="kw">&lt;/x-1&gt;&lt;a&gt;&lt;/a&gt;&lt;/a</span></a>
<a class="sourceLine" id="cb30-5" title="5"><span class="kw">&gt;&lt;/x&gt;</span></a></code></pre></div>
<h3 id="分析-html-代码中的图片列表">分析 HTML 代码中的图片列表</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb31-1" title="1"><span class="kw">var</span> source <span class="op">=</span></a>
<a class="sourceLine" id="cb31-2" title="2">  <span class="st">&#39;&lt;img src=&quot;img1&quot;&gt;a&lt;img src=&quot;img2&quot;&gt;b&lt;img src=&quot;img3&quot;&gt;c&lt;img src=&quot;img4&quot;&gt;d&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb31-3" title="3"><span class="kw">var</span> list <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb31-4" title="4"><span class="kw">var</span> html <span class="op">=</span> <span class="at">xss</span>(source<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb31-5" title="5">  <span class="dt">onTagAttr</span><span class="op">:</span> <span class="kw">function</span> (tag<span class="op">,</span> name<span class="op">,</span> value<span class="op">,</span> isWhiteAttr) <span class="op">{</span></a>
<a class="sourceLine" id="cb31-6" title="6">    <span class="cf">if</span> (tag <span class="op">===</span> <span class="st">&quot;img&quot;</span> <span class="op">&amp;&amp;</span> name <span class="op">===</span> <span class="st">&quot;src&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb31-7" title="7">      <span class="co">// 使用内置的friendlyAttrValue函数来对属性值进行转义，可将&amp;lt;这类的实体标记转换成打印字符&lt;</span></a>
<a class="sourceLine" id="cb31-8" title="8">      <span class="va">list</span>.<span class="at">push</span>(<span class="va">xss</span>.<span class="at">friendlyAttrValue</span>(value))<span class="op">;</span></a>
<a class="sourceLine" id="cb31-9" title="9">    <span class="op">}</span></a>
<a class="sourceLine" id="cb31-10" title="10">    <span class="co">// 不返回任何值，表示还是按照默认的方法处理</span></a>
<a class="sourceLine" id="cb31-11" title="11">  <span class="op">},</span></a>
<a class="sourceLine" id="cb31-12" title="12"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb31-13" title="13"></a>
<a class="sourceLine" id="cb31-14" title="14"><span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;image list:</span><span class="sc">\n</span><span class="st">%s&quot;</span><span class="op">,</span> <span class="va">list</span>.<span class="at">join</span>(<span class="st">&quot;, &quot;</span>))<span class="op">;</span></a></code></pre></div>
<p>运行结果：</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb32-1" title="1">image list: img1, img2, img3, img4</a></code></pre></div>
<h3 id="去除-html-标签只保留文本内容">去除 HTML 标签（只保留文本内容）</h3>
<div class="sourceCode" id="cb33"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb33-1" title="1"><span class="kw">var</span> source <span class="op">=</span> <span class="st">&quot;&lt;strong&gt;hello&lt;/strong&gt;&lt;script&gt;alert(/xss/);&lt;/script&gt;end&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb33-2" title="2"><span class="kw">var</span> html <span class="op">=</span> <span class="at">xss</span>(source<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb33-3" title="3">  <span class="dt">whiteList</span><span class="op">:</span> <span class="op">{},</span> <span class="co">// 白名单为空，表示过滤所有标签</span></a>
<a class="sourceLine" id="cb33-4" title="4">  <span class="dt">stripIgnoreTag</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="co">// 过滤所有非白名单标签的HTML</span></a>
<a class="sourceLine" id="cb33-5" title="5">  <span class="dt">stripIgnoreTagBody</span><span class="op">:</span> [<span class="st">&quot;script&quot;</span>]<span class="op">,</span> <span class="co">// script标签较特殊，需要过滤标签中间的内容</span></a>
<a class="sourceLine" id="cb33-6" title="6"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb33-7" title="7"></a>
<a class="sourceLine" id="cb33-8" title="8"><span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;text: %s&quot;</span><span class="op">,</span> html)<span class="op">;</span></a></code></pre></div>
<p>运行结果：</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb34-1" title="1">text: helloend</a></code></pre></div>
<h2 id="授权协议">授权协议</h2>
<pre class="text"><code>Copyright (c) 2012-2018 Zongmin Lei(雷宗民) &lt;leizongmin@gmail.com&gt;
http://ucdok.com

The MIT License

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
&quot;Software&quot;), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</code></pre>
</body>
</html>
