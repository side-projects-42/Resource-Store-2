<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<p align="center">
<a href="https://github.com/pubkey/broadcast-channel"> <img src="../docs/files/icon.png" width="150px" /> </a>
</p>
<h1 align="center">
BroadcastChannel
</h1>
<p align="center">
<strong>A BroadcastChannel to send data between different browser-tabs or nodejs-processes</strong> <br/> <span>+ LeaderElection over the channels</span><br />
</p>
<p align="center">
<a href="https://twitter.com/pubkeypubkey"> <img src="https://img.shields.io/twitter/follow/pubkeypubkey.svg?style=social&logo=twitter"
            alt="follow on Twitter"></a>
</p>
<figure>
<img src="../docs/files/demo.gif" alt="demo.gif" /><figcaption>demo.gif</figcaption>
</figure>
<hr />
<p>A BroadcastChannel that allows you to send data between different browser-tabs or nodejs-processes.</p>
<ul>
<li>It works completely <strong>client-side</strong> and <strong>offline</strong>.</li>
<li>Tested on <strong>old browsers</strong>, <strong>new browsers</strong>, <strong>WebWorkers</strong>, <strong>Iframes</strong> and <strong>NodeJs</strong></li>
</ul>
<p>This behaves similar to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API">BroadcastChannel-API</a> which is currently only featured in <a href="https://caniuse.com/#feat=broadcastchannel">some browsers</a>.</p>
<h2 id="using-the-broadcastchannel">Using the BroadcastChannel</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">npm</span> install --save broadcast-channel</a></code></pre></div>
<h4 id="create-a-channel-in-one-tabprocess-and-send-a-message.">Create a channel in one tab/process and send a message.</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode ts"><code class="sourceCode typescript"><a class="sourceLine" id="cb2-1" title="1"><span class="im">import</span> <span class="op">{</span> BroadcastChannel <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">const</span> channel <span class="op">=</span> <span class="kw">new</span> <span class="fu">BroadcastChannel</span>(<span class="st">&#39;foobar&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="va">channel</span><span class="op">.</span><span class="fu">postMessage</span>(<span class="st">&#39;I am not alone&#39;</span>)<span class="op">;</span></a></code></pre></div>
<h4 id="create-a-channel-with-the-same-name-in-another-tabprocess-and-recieve-messages.">Create a channel with the same name in another tab/process and recieve messages.</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode ts"><code class="sourceCode typescript"><a class="sourceLine" id="cb3-1" title="1"><span class="im">import</span> <span class="op">{</span> BroadcastChannel <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">const</span> channel <span class="op">=</span> <span class="kw">new</span> <span class="fu">BroadcastChannel</span>(<span class="st">&#39;foobar&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="va">channel</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> msg <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">dir</span>(msg)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">// &gt; &#39;I am not alone&#39;</span></a></code></pre></div>
<h4 id="add-and-remove-multiple-eventlisteners">Add and remove multiple eventlisteners</h4>
<div class="sourceCode" id="cb4"><pre class="sourceCode ts"><code class="sourceCode typescript"><a class="sourceLine" id="cb4-1" title="1"><span class="im">import</span> <span class="op">{</span> BroadcastChannel <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">const</span> channel <span class="op">=</span> <span class="kw">new</span> <span class="fu">BroadcastChannel</span>(<span class="st">&#39;foobar&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">const</span> handler <span class="op">=</span> msg <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(msg)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="va">channel</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> handler)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">// remove it</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="va">channel</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> handler)<span class="op">;</span></a></code></pre></div>
<h4 id="close-the-channel-if-you-do-not-need-it-anymore.">Close the channel if you do not need it anymore.</h4>
<p>Returns a <code>Promise</code> that resolved when everything is processed.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="cf">await</span> <span class="va">channel</span>.<span class="at">close</span>()<span class="op">;</span></a></code></pre></div>
<h4 id="set-options-when-creating-a-channel-optional">Set options when creating a channel (optional):</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">const</span> options <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">    <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;localstorage&#39;</span><span class="op">,</span> <span class="co">// (optional) enforce a type, oneOf[&#39;native&#39;, &#39;idb&#39;, &#39;localstorage&#39;, &#39;node&#39;]</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="dt">webWorkerSupport</span><span class="op">:</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// (optional) set this to false if you know that your channel will never be used in a WebWorker (increases performance)</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="op">};</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="kw">const</span> channel <span class="op">=</span> <span class="kw">new</span> <span class="at">BroadcastChannel</span>(<span class="st">&#39;foobar&#39;</span><span class="op">,</span> options)<span class="op">;</span></a></code></pre></div>
<h4 id="create-a-typed-channel-in-typescript">Create a typed channel in typescript:</h4>
<div class="sourceCode" id="cb7"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb7-1" title="1"><span class="im">import</span> <span class="op">{</span> BroadcastChannel <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">declare</span> <span class="kw">type</span> Message <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-3" title="3">  foo<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="op">};</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="kw">const</span> channel<span class="op">:</span> BroadcastChannel<span class="op">&lt;</span>Message<span class="op">&gt;</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">BroadcastChannel</span>(<span class="st">&#39;foobar&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="va">channel</span><span class="op">.</span><span class="fu">postMessage</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb7-7" title="7">  foo<span class="op">:</span> <span class="st">&#39;bar&#39;</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h4 id="enforce-a-options-globally">Enforce a options globally</h4>
<p>When you use this module in a test-suite, it is recommended to enforce the fast <code>simulate</code> method on all channels so your tests run faster. You can do this with <code>enforceOptions()</code>. If you set this, all channels have the enforced options, no mather what options are given in the constructor.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb8-1" title="1"><span class="im">import</span> <span class="op">{</span> enforceOptions <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">// enforce this config for all channels</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="fu">enforceOptions</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb8-5" title="5">  type<span class="op">:</span> <span class="st">&#39;simulate&#39;</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-7" title="7"></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">// reset the enforcement</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="fu">enforceOptions</span>(<span class="kw">null</span>)<span class="op">;</span></a></code></pre></div>
<h4 id="clear-tmp-folder">Clear tmp-folder:</h4>
<p>When used in NodeJs, the BroadcastChannel will communicate with other processes over filesystem based sockets. When you create a huge amount of channels, like you would do when running unit tests, you might get problems because there are too many folders in the tmp-directory. Calling <code>BroadcastChannel.clearNodeFolder()</code> will clear the tmp-folder and it is recommended to run this at the beginning of your test-suite.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb9-1" title="1"><span class="im">import</span> <span class="op">{</span> clearNodeFolder <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">// jest</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="fu">beforeAll</span>(<span class="fu">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-4" title="4">  <span class="kw">const</span> hasRun <span class="op">=</span> <span class="cf">await</span> <span class="fu">clearNodeFolder</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-5" title="5">  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(hasRun)<span class="op">;</span> <span class="co">// &gt; true on NodeJs, false on Browsers</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="op">}</span>)</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb10-1" title="1"><span class="im">import</span> <span class="op">{</span> clearNodeFolder <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="co">// mocha</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="fu">before</span>(<span class="fu">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-4" title="4">  <span class="kw">const</span> hasRun <span class="op">=</span> <span class="cf">await</span> <span class="fu">clearNodeFolder</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(hasRun)<span class="op">;</span> <span class="co">// &gt; true on NodeJs, false on Browsers</span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="op">}</span>)</a></code></pre></div>
<h4 id="handling-indexeddb-onclose-events">Handling IndexedDB onclose events</h4>
<p>IndexedDB databases can close unexpectedly for various reasons. This could happen, for example, if the underlying storage is removed or if the user clears the database in the browser’s history preferences. Most often we have seen this happen in Mobile Safari. By default, we let the connection close and stop polling for changes. If you would like to continue listening you should close BroadcastChannel and create a new one.</p>
<p>Example of how you might do this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode typescript"><code class="sourceCode typescript"><a class="sourceLine" id="cb11-1" title="1"><span class="im">import</span> <span class="op">{</span> BroadcastChannel <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="kw">let</span> channel<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="kw">const</span> createChannel <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-6" title="6">  channel <span class="op">=</span> <span class="kw">new</span> <span class="fu">BroadcastChannel</span>(CHANNEL_NAME<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-7" title="7">    idb<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-8" title="8">      onclose<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-9" title="9">        <span class="co">// the onclose event is just the IndexedDB closing.</span></a>
<a class="sourceLine" id="cb11-10" title="10">        <span class="co">// you should also close the channel before creating</span></a>
<a class="sourceLine" id="cb11-11" title="11">        <span class="co">// a new one.</span></a>
<a class="sourceLine" id="cb11-12" title="12">        <span class="va">channel</span><span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-13" title="13">        <span class="fu">createChannel</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-14" title="14">      <span class="op">},</span></a>
<a class="sourceLine" id="cb11-15" title="15">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-16" title="16">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-17" title="17"></a>
<a class="sourceLine" id="cb11-18" title="18">  <span class="va">channel</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> message <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-19" title="19">    <span class="co">// handle message</span></a>
<a class="sourceLine" id="cb11-20" title="20">  <span class="op">};</span></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="op">};</span></a></code></pre></div>
<h2 id="methods">Methods:</h2>
<p>Depending in which environment this is used, a proper method is automatically selected to ensure it always works.</p>
<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 27%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Used in</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Native</strong></td>
<td><a href="https://caniuse.com/broadcastchannel">Modern Browsers</a></td>
<td>If the browser supports the BroadcastChannel-API, this method will be used because it is the fastest</td>
</tr>
<tr class="even">
<td><strong>IndexedDB</strong></td>
<td><a href="https://caniuse.com/#feat=indexeddb">Browsers with WebWorkers</a></td>
<td>If there is no native BroadcastChannel support, the IndexedDB method is used because it supports messaging between browser-tabs, iframes and WebWorkers</td>
</tr>
<tr class="odd">
<td><strong>LocalStorage</strong></td>
<td><a href="https://caniuse.com/#feat=namevalue-storage">Older Browsers</a></td>
<td>In older browsers that do not support IndexedDb, a localstorage-method is used</td>
</tr>
<tr class="even">
<td><strong>Sockets</strong></td>
<td>NodeJs</td>
<td>In NodeJs the communication is handled by sockets that send each other messages</td>
</tr>
<tr class="odd">
<td><strong>Simulate</strong></td>
<td>none per default</td>
<td>This method simulates the behavior of the other methods but only runs in the current process without sharing data between processes. Use this method in your test-suite because it is much faster.</td>
</tr>
</tbody>
</table>
<h2 id="using-the-leaderelection">Using the LeaderElection</h2>
<p>This module also comes with a leader-election which can be used so elect a leader between different BroadcastChannels. For example if you have a stable connection from the frontend to your server, you can use the LeaderElection to save server-side performance by only connecting once, even if the user has opened your website in multiple tabs.</p>
<p>In this example the leader is marked with the crown ♛: <img src="../docs/files/leader-election.gif" alt="leader-election.gif" /></p>
<p>Create a channel and an elector.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode ts"><code class="sourceCode typescript"><a class="sourceLine" id="cb12-1" title="1"><span class="im">import</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  BroadcastChannel<span class="op">,</span></a>
<a class="sourceLine" id="cb12-3" title="3">  createLeaderElection</a>
<a class="sourceLine" id="cb12-4" title="4"><span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="kw">const</span> channel <span class="op">=</span> <span class="kw">new</span> <span class="fu">BroadcastChannel</span>(<span class="st">&#39;foobar&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="kw">const</span> elector <span class="op">=</span> <span class="fu">createLeaderElection</span>(channel)<span class="op">;</span></a></code></pre></div>
<p>Wait until the elector becomes leader.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="im">import</span> <span class="op">{</span> createLeaderElection <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="kw">const</span> elector <span class="op">=</span> <span class="at">createLeaderElection</span>(channel)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="va">elector</span>.<span class="at">awaitLeadership</span>().<span class="at">then</span>(()<span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-4" title="4">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;this tab is now leader&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="op">}</span>)</a></code></pre></div>
<p>If more than one tab is becoming leader adjust <code>LeaderElectionOptions</code> configuration.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="im">import</span> <span class="op">{</span> createLeaderElection <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;broadcast-channel&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw">const</span> elector <span class="op">=</span> <span class="at">createLeaderElection</span>(channel<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="dt">fallbackInterval</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span> <span class="co">// optional configuration for how often will renegotiation for leader occur</span></a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="dt">responseTime</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span> <span class="co">// optional configuration for how long will instances have to respond</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="va">elector</span>.<span class="at">awaitLeadership</span>().<span class="at">then</span>(()<span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;this tab is now leader&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-8" title="8"><span class="op">}</span>)</a></code></pre></div>
<p>Let the leader die. (automatically happens if the tab is closed or the process exits).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">const</span> elector <span class="op">=</span> <span class="at">createLeaderElection</span>(channel)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="cf">await</span> <span class="va">elector</span>.<span class="at">die</span>()<span class="op">;</span></a></code></pre></div>
<p>Handle duplicate leaders. This can happen on rare occurences like when the <a href="https://github.com/pubkey/broadcast-channel/issues/385">CPU is on 100%</a> for longer time, or the browser <a href="https://github.com/pubkey/broadcast-channel/issues/414">has throttled the javascript timers</a>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">const</span> elector <span class="op">=</span> <span class="at">createLeaderElection</span>(channel)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="va">elector</span>.<span class="at">onduplicate</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="at">alert</span>(<span class="st">&#39;have duplicate leaders!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="op">}</span></a></code></pre></div>
<h2 id="what-this-is">What this is</h2>
<p>This module is optimised for:</p>
<ul>
<li><strong>low latency</strong>: When you postMessage on one channel, it should take as low as possible time until other channels recieve the message.</li>
<li><strong>lossless</strong>: When you send a message, it should be impossible that the message is lost before other channels recieved it</li>
<li><strong>low idle workload</strong>: During the time when no messages are send, there should be a low processor footprint.</li>
</ul>
<h2 id="what-this-is-not">What this is not</h2>
<ul>
<li>This is not a polyfill. Do not set this module to <code>window.BroadcastChannel</code>. This implementation behaves similiar to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API">BroadcastChannel-Standard</a> with these limitations:
<ul>
<li>You can only send data that can be <code>JSON.stringify</code>-ed.</li>
<li>While the offical API emits <a href="https://developer.mozilla.org/en-US/docs/Web/API/BroadcastChannel/onmessage">onmessage-events</a>, this module directly emitts the data which was posted</li>
</ul></li>
<li>This is not a replacement for a message queue. If you use this in NodeJs and want send more than 50 messages per second, you should use proper <a href="https://en.wikipedia.org/wiki/Message_queue">IPC-Tooling</a></li>
</ul>
<h2 id="browser-support">Browser Support</h2>
<p>I have tested this in all browsers that I could find. For ie8 and ie9 you must transpile the code before you can use this. If you want to know if this works with your browser, <a href="https://pubkey.github.io/broadcast-channel/e2e.html">open the demo page</a>.</p>
<h2 id="thanks">Thanks</h2>
<p>Thanks to <a href="https://github.com/hemanth">Hemanth.HM</a> for the module name.</p>
</body>
</html>
