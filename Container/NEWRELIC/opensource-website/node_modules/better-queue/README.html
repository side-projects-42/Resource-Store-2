<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="better-queue---powerful-flow-control">Better Queue - Powerful flow control</h1>
<p><a href="https://nodei.co/npm/better-queue/"><img src="https://nodei.co/npm/better-queue.png?downloads=true&amp;downloadRank=true&amp;stars=true" alt="npm package" /></a></p>
<p><a href="https://travis-ci.org/diamondio/better-queue"><img src="https://img.shields.io/travis/diamondio/better-queue.svg?style=flat-square" alt="Build status" /></a> <a href="https://david-dm.org/diamondio/better-queue"><img src="https://img.shields.io/david/diamondio/better-queue.svg?style=flat-square" alt="Dependency Status" /></a> <a href="https://snyk.io/test/npm/better-queue"><img src="https://snyk.io/test/npm/better-queue/badge.svg?style=flat-square" alt="Known Vulnerabilities" /></a> <a href="https://gitter.im/diamondio/better-queue?utm_source=badge"><img src="https://img.shields.io/badge/gitter-join_chat-blue.svg?style=flat-square" alt="Gitter" /></a></p>
<h2 id="super-simple-to-use">Super simple to use</h2>
<p>Better Queue is designed to be simple to set up but still let you do complex things.</p>
<ul>
<li>Persistent (and extendable) storage</li>
<li>Batched processing</li>
<li>Prioritize tasks</li>
<li>Merge/filter tasks</li>
<li>Progress events (with ETA!)</li>
<li>Fine-tuned timing controls</li>
<li>Retry on fail</li>
<li>Concurrent batch processing</li>
<li>Task statistics (average completion time, failure rate and peak queue size)</li>
<li>… and more!</li>
</ul>
<hr />
<h4 id="install-via-npm">Install (via npm)</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">npm</span> install --save better-queue</a></code></pre></div>
<hr />
<h4 id="quick-example">Quick Example</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">var</span> Queue <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;better-queue&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (input<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-4" title="4">  </a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="co">// Some processing here ...</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7">  <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> result)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb2-9" title="9"></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-11" title="11"><span class="va">q</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">x</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)</a></code></pre></div>
<h2 id="table-of-contents">Table of contents</h2>
<ul>
<li><a href="#queuing">Queuing</a></li>
<li><a href="#task-management">Task Management</a></li>
<li><a href="#queue-management">Queue Management</a></li>
<li><a href="#advanced">Advanced</a></li>
<li><a href="#storage">Storage</a></li>
<li><a href="#full-documentation">Full Documentation</a></li>
</ul>
<hr />
<p>You will be able to combine any (and all) of these options for your queue!</p>
<h2 id="queuing">Queuing</h2>
<p>It’s very easy to push tasks into the queue.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="va">q</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">x</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="dv">2</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="va">q</span>.<span class="at">push</span>(<span class="st">&quot;hello&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>You can also include a callback as a second parameter to the push function, which would be called when that task is done. For example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">1</span><span class="op">,</span> <span class="kw">function</span> (err<span class="op">,</span> result) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="co">// Results from the task!</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>You can also listen to events on the results of the <code>push</code> call.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-3" title="3">  .<span class="at">on</span>(<span class="st">&#39;finish&#39;</span><span class="op">,</span> <span class="kw">function</span> (result) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="co">// Task succeeded with {result}!</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb5-6" title="6">  .<span class="at">on</span>(<span class="st">&#39;failed&#39;</span><span class="op">,</span> <span class="kw">function</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="co">// Task failed!</span></a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="op">}</span>)</a></code></pre></div>
<p>Alternatively, you can subscribe to the queue’s events.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="va">q</span>.<span class="at">on</span>(<span class="st">&#39;task_finish&#39;</span><span class="op">,</span> <span class="kw">function</span> (taskId<span class="op">,</span> result<span class="op">,</span> stats) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="co">// taskId = 1, result: 3, stats = { elapsed: &lt;time taken&gt; }</span></a>
<a class="sourceLine" id="cb6-4" title="4">  <span class="co">// taskId = 2, result: 5, stats = { elapsed: &lt;time taken&gt; }</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb6-6" title="6"><span class="va">q</span>.<span class="at">on</span>(<span class="st">&#39;task_failed&#39;</span><span class="op">,</span> <span class="kw">function</span> (taskId<span class="op">,</span> err<span class="op">,</span> stats) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-7" title="7">  <span class="co">// Handle error, stats = { elapsed: &lt;time taken&gt; }</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb6-9" title="9"><span class="va">q</span>.<span class="at">on</span>(<span class="st">&#39;empty&#39;</span><span class="op">,</span> <span class="kw">function</span> ()<span class="op">{}</span>)</a>
<a class="sourceLine" id="cb6-10" title="10"><span class="va">q</span>.<span class="at">on</span>(<span class="st">&#39;drain&#39;</span><span class="op">,</span> <span class="kw">function</span> ()<span class="op">{}</span>)</a>
<a class="sourceLine" id="cb6-11" title="11"><span class="va">q</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">a</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">b</span><span class="op">:</span> <span class="dv">2</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="va">q</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">a</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">b</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p><code>empty</code> event fires when all of the tasks have been pulled off of the queue (there may still be tasks running!)</p>
<p><code>drain</code> event fires when there are no more tasks on the queue <em>and</em> when no more tasks are running.</p>
<p>You can control how many tasks process at the same time.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn<span class="op">,</span> <span class="op">{</span> <span class="dt">concurrent</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span>)</a></code></pre></div>
<p>Now the queue will allow 3 tasks running at the same time. (By default, we handle tasks one at a time.)</p>
<p>You can also turn the queue into a stack by turning on <code>filo</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn<span class="op">,</span> <span class="op">{</span> <span class="dt">filo</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a></code></pre></div>
<p>Now items you push on will be handled first.</p>
<p><a href="#table-of-contents">back to top</a></p>
<hr />
<h2 id="task-management">Task Management</h2>
<h4 id="task-id">Task ID</h4>
<p>Tasks can be given an ID to help identify and track it as it goes through the queue.</p>
<p>By default, we look for <code>task.id</code> to see if it’s a string property, otherwise we generate a random ID for the task.</p>
<p>You can pass in an <code>id</code> property to options to change this behaviour. Here are some examples of how:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;id&#39;</span><span class="op">,</span>   <span class="co">// Default: task&#39;s `id` property</span></a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="co">// task&#39;s `name` property</span></a>
<a class="sourceLine" id="cb9-4" title="4">  <span class="dt">id</span><span class="op">:</span> <span class="kw">function</span> (task<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-5" title="5">    <span class="co">// Compute the ID</span></a>
<a class="sourceLine" id="cb9-6" title="6">    <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="st">&#39;computed_id&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="op">}</span>)</a></code></pre></div>
<p>One thing you can do with Task ID is merge tasks:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">var</span> counter <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (task<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;I have %d %ss.&quot;</span><span class="op">,</span> <span class="va">task</span>.<span class="at">count</span><span class="op">,</span> <span class="va">task</span>.<span class="at">id</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-3" title="3">  <span class="at">cb</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="op">},</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="dt">merge</span><span class="op">:</span> <span class="kw">function</span> (oldTask<span class="op">,</span> newTask<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-6" title="6">    <span class="va">oldTask</span>.<span class="at">count</span> <span class="op">+=</span> <span class="va">newTask</span>.<span class="at">count</span><span class="op">;</span></a>
<a class="sourceLine" id="cb10-7" title="7">    <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> oldTask)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb10-10" title="10"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;apple&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">2</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;apple&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;orange&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;orange&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb10-14" title="14"><span class="co">// Prints out:</span></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">//   I have 3 apples.</span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">//   I have 2 oranges.</span></a></code></pre></div>
<p>By default, if tasks have the same ID they replace the previous task.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">var</span> counter <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (task<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;I have %d %ss.&quot;</span><span class="op">,</span> <span class="va">task</span>.<span class="at">count</span><span class="op">,</span> <span class="va">task</span>.<span class="at">id</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="at">cb</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb11-5" title="5"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;apple&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;apple&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;orange&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;orange&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">2</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">// Prints out:</span></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">//   I have 3 apples.</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">//   I have 2 oranges.</span></a></code></pre></div>
<p>You can also use the task ID when subscribing to events from Queue.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">var</span> counter <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn)</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="va">counter</span>.<span class="at">on</span>(<span class="st">&#39;task_finish&#39;</span><span class="op">,</span> <span class="kw">function</span> (taskId<span class="op">,</span> result) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="co">// taskId will be &#39;jim&#39; or &#39;bob&#39;</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb12-5" title="5"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;jim&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">2</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="va">counter</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;bob&#39;</span><span class="op">,</span> <span class="dt">count</span><span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h4 id="batch-processing">Batch Processing</h4>
<p>Your processing function can also be modified to handle multiple tasks at the same time. For example:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">var</span> ages <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (batch<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="co">// Batch 1:</span></a>
<a class="sourceLine" id="cb13-3" title="3">  <span class="co">//   [ { id: &#39;steve&#39;, age: 21 },</span></a>
<a class="sourceLine" id="cb13-4" title="4">  <span class="co">//     { id: &#39;john&#39;, age: 34 },</span></a>
<a class="sourceLine" id="cb13-5" title="5">  <span class="co">//     { id: &#39;joe&#39;, age: 18 } ]</span></a>
<a class="sourceLine" id="cb13-6" title="6">  <span class="co">// Batch 2:</span></a>
<a class="sourceLine" id="cb13-7" title="7">  <span class="co">//   [ { id: &#39;mary&#39;, age: 23 } ]</span></a>
<a class="sourceLine" id="cb13-8" title="8">  <span class="at">cb</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="op">},</span> <span class="op">{</span> <span class="dt">batchSize</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb13-10" title="10"><span class="va">ages</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;steve&#39;</span><span class="op">,</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">21</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-11" title="11"><span class="va">ages</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;john&#39;</span><span class="op">,</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">34</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="va">ages</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;joe&#39;</span><span class="op">,</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">18</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="va">ages</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;mary&#39;</span><span class="op">,</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">23</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Note how the queue will only handle at most 3 items at a time.</p>
<p>Below is another example of a batched call with numbers.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">var</span> ages <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (batch<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="co">// batch = [1,2,3]</span></a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="at">cb</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="op">},</span> <span class="op">{</span> <span class="dt">batchSize</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb14-5" title="5"><span class="va">ages</span>.<span class="at">push</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="va">ages</span>.<span class="at">push</span>(<span class="dv">2</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-7" title="7"><span class="va">ages</span>.<span class="at">push</span>(<span class="dv">3</span>)<span class="op">;</span></a></code></pre></div>
<h4 id="filtering-validation-and-priority">Filtering, Validation and Priority</h4>
<p>You can also format (and filter) the input that arrives from a push before it gets processed by the queue by passing in a <code>filter</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">var</span> greeter <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (name<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Hello, %s!&quot;</span><span class="op">,</span> name)</a>
<a class="sourceLine" id="cb15-3" title="3">  <span class="at">cb</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="op">},</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-5" title="5">  <span class="dt">filter</span><span class="op">:</span> <span class="kw">function</span> (input<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-6" title="6">    <span class="cf">if</span> (input <span class="op">===</span> <span class="st">&#39;Bob&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-7" title="7">      <span class="cf">return</span> <span class="at">cb</span>(<span class="st">&#39;not_allowed&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-8" title="8">    <span class="op">}</span></a>
<a class="sourceLine" id="cb15-9" title="9">    <span class="cf">return</span> <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="va">input</span>.<span class="at">toUpperCase</span>())</a>
<a class="sourceLine" id="cb15-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb15-11" title="11"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="va">greeter</span>.<span class="at">push</span>(<span class="st">&#39;anna&#39;</span>)<span class="op">;</span> <span class="co">// Prints &#39;Hello, ANNA!&#39;</span></a></code></pre></div>
<p>This can be particularly useful if your queue needs to do some pre-processing, input validation, database lookup, etc. before you load it onto the queue.</p>
<p>You can also define a priority function to control which tasks get processed first.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">var</span> greeter <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (name<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb16-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Greetings, %s.&quot;</span><span class="op">,</span> name)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="at">cb</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="op">},</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-5" title="5">  <span class="dt">priority</span><span class="op">:</span> <span class="kw">function</span> (name<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb16-6" title="6">    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;Steve&quot;</span>) <span class="cf">return</span> <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-7" title="7">    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;Mary&quot;</span>) <span class="cf">return</span> <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-8" title="8">    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;Joe&quot;</span>) <span class="cf">return</span> <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-9" title="9">    <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb16-12" title="12"><span class="va">greeter</span>.<span class="at">push</span>(<span class="st">&quot;Steve&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-13" title="13"><span class="va">greeter</span>.<span class="at">push</span>(<span class="st">&quot;John&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-14" title="14"><span class="va">greeter</span>.<span class="at">push</span>(<span class="st">&quot;Joe&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-15" title="15"><span class="va">greeter</span>.<span class="at">push</span>(<span class="st">&quot;Mary&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-16" title="16"></a>
<a class="sourceLine" id="cb16-17" title="17"><span class="co">// Prints out:</span></a>
<a class="sourceLine" id="cb16-18" title="18"><span class="co">//   Greetings, Steve.</span></a>
<a class="sourceLine" id="cb16-19" title="19"><span class="co">//   Greetings, Joe.</span></a>
<a class="sourceLine" id="cb16-20" title="20"><span class="co">//   Greetings, Mary.</span></a>
<a class="sourceLine" id="cb16-21" title="21"><span class="co">//   Greetings, John.</span></a></code></pre></div>
<p>If <code>filo</code> is set to <code>true</code> in the example above, then Joe and Mary would swap order.</p>
<p><a href="#table-of-contents">back to top</a></p>
<hr />
<h2 id="queue-management">Queue Management</h2>
<h4 id="retry">Retry</h4>
<p>You can set tasks to retry <code>maxRetries</code> times if they fail. By default, tasks will fail (and will not retry.) Optionally, you can set a <code>retryDelay</code> to wait a little while before retrying.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn<span class="op">,</span> <span class="op">{</span> <span class="dt">maxRetries</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">retryDelay</span><span class="op">:</span> <span class="dv">1000</span> <span class="op">}</span>)</a></code></pre></div>
<h4 id="timing">Timing</h4>
<p>You can configure the queue to have a <code>maxTimeout</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (name<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="at">someLongTask</span>(<span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb18-3" title="3">    <span class="at">cb</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb18-4" title="4">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb18-5" title="5"><span class="op">},</span> <span class="op">{</span> <span class="dt">maxTimeout</span><span class="op">:</span> <span class="dv">2000</span> <span class="op">}</span>)</a></code></pre></div>
<p>After 2 seconds, the process will throw an error instead of waiting for the callback to finish.</p>
<p>You can also delay the queue before it starts its processing. This is the behaviour of a timed cargo.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (batch<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="co">// Batch [1,2] will process after 2s.</span></a>
<a class="sourceLine" id="cb19-3" title="3">  <span class="at">cb</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="op">},</span> <span class="op">{</span> <span class="dt">batchSize</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dt">batchDelay</span><span class="op">:</span> <span class="dv">2000</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb19-5" title="5"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb19-7" title="7">  <span class="va">q</span>.<span class="at">push</span>(<span class="dv">2</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="op">},</span> <span class="dv">1000</span>)</a></code></pre></div>
<p>You can also set <code>afterProcessDelay</code>, which will delay processing between tasks.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb20-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (task<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-2" title="2">  <span class="at">cb</span>()<span class="op">;</span> <span class="co">// Will wait 1 second before taking the next task</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="op">},</span> <span class="op">{</span> <span class="dt">afterProcessDelay</span><span class="op">:</span> <span class="dv">1000</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb20-4" title="4"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">2</span>)<span class="op">;</span></a></code></pre></div>
<p>Instead of just the <code>batchDelay</code>, you can add a <code>batchDelayTimeout</code>, which is for firing off a batch if it hasn’t had any new tasks pushed to the queue in the <code>batchDelayTimeout</code> time (in milliseconds.)</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb21-2" title="2">  <span class="dt">batchSize</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></a>
<a class="sourceLine" id="cb21-3" title="3">  <span class="dt">batchDelay</span><span class="op">:</span> <span class="dv">5000</span><span class="op">,</span></a>
<a class="sourceLine" id="cb21-4" title="4">  <span class="dt">batchDelayTimeout</span><span class="op">:</span> <span class="dv">1000</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb21-6" title="6"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="va">q</span>.<span class="at">push</span>(<span class="dv">2</span>)<span class="op">;</span></a></code></pre></div>
<p>In the example above, the queue will wait for 50 items to fill up in 5s or process the queue if no new tasks were added in 1s.</p>
<h4 id="precondition">Precondition</h4>
<p>You can define a function called <code>precondition</code> that checks that it’s ok to process the next batch. If the preconditions fail, it will keep calling this function until it passes again.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (batch<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb22-2" title="2"></a>
<a class="sourceLine" id="cb22-3" title="3">  <span class="co">// Do something that requires internet</span></a>
<a class="sourceLine" id="cb22-4" title="4"></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="op">},</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb22-6" title="6">  <span class="dt">precondition</span><span class="op">:</span> <span class="kw">function</span> (cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb22-7" title="7">    <span class="at">isOnline</span>(<span class="kw">function</span> (err<span class="op">,</span> ok) <span class="op">{</span></a>
<a class="sourceLine" id="cb22-8" title="8">      <span class="cf">if</span> (ok) <span class="op">{</span></a>
<a class="sourceLine" id="cb22-9" title="9">        <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb22-10" title="10">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb22-11" title="11">        <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb22-12" title="12">      <span class="op">}</span></a>
<a class="sourceLine" id="cb22-13" title="13">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb22-14" title="14">  <span class="op">},</span></a>
<a class="sourceLine" id="cb22-15" title="15">  <span class="dt">preconditionRetryTimeout</span><span class="op">:</span> <span class="dv">10</span><span class="op">*</span><span class="dv">1000</span> <span class="co">// If we go offline, retry every 10s</span></a>
<a class="sourceLine" id="cb22-16" title="16"><span class="op">}</span>)</a></code></pre></div>
<h4 id="pauseresume">Pause/Resume</h4>
<p>There are options to control processes while they are running.</p>
<p>You can return an object in your processing function with the functions <code>cancel</code>, <code>pause</code> and <code>resume</code>. This will allow operations to pause, resume or cancel while it’s running.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">var</span> uploader <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (file<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb23-2" title="2">  </a>
<a class="sourceLine" id="cb23-3" title="3">  <span class="kw">var</span> worker <span class="op">=</span> <span class="at">someLongProcess</span>(file)<span class="op">;</span></a>
<a class="sourceLine" id="cb23-4" title="4"></a>
<a class="sourceLine" id="cb23-5" title="5">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb23-6" title="6">    <span class="dt">cancel</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb23-7" title="7">      <span class="co">// Cancel the file upload</span></a>
<a class="sourceLine" id="cb23-8" title="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb23-9" title="9">    <span class="dt">pause</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb23-10" title="10">      <span class="co">// Pause the file upload</span></a>
<a class="sourceLine" id="cb23-11" title="11">    <span class="op">},</span></a>
<a class="sourceLine" id="cb23-12" title="12">    <span class="dt">resume</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb23-13" title="13">      <span class="co">// Resume the file upload</span></a>
<a class="sourceLine" id="cb23-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb23-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb23-16" title="16"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb23-17" title="17"><span class="va">uploader</span>.<span class="at">push</span>(<span class="st">&#39;/path/to/file.pdf&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb23-18" title="18"><span class="va">uploader</span>.<span class="at">pause</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb23-19" title="19"><span class="va">uploader</span>.<span class="at">resume</span>()<span class="op">;</span></a></code></pre></div>
<h4 id="cancelabort">Cancel/Abort</h4>
<p>You can also set <code>cancelIfRunning</code> to <code>true</code>. This will cancel a running task if a task with the same ID is pushed onto the queue.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">var</span> uploader <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (file<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb24-2" title="2">  <span class="kw">var</span> request <span class="op">=</span> <span class="at">someLongProcess</span>(file)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-3" title="3">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-4" title="4">    <span class="dt">cancel</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb24-5" title="5">      <span class="va">request</span>.<span class="at">cancel</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb24-6" title="6">    <span class="op">}</span></a>
<a class="sourceLine" id="cb24-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="op">},</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-9" title="9">  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;path&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb24-10" title="10">  <span class="dt">cancelIfRunning</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb24-11" title="11"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb24-12" title="12"><span class="va">uploader</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/path/to/file.pdf&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-13" title="13"><span class="co">// ... Some time later</span></a>
<a class="sourceLine" id="cb24-14" title="14"><span class="va">uploader</span>.<span class="at">push</span>(<span class="op">{</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/path/to/file.pdf&#39;</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>In the example above, the first upload process is cancelled and the task is requeued.</p>
<p>You can also call <code>.cancel(taskId)</code> to cancel and unqueue the task.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb25-1" title="1"><span class="va">uploader</span>.<span class="at">cancel</span>(<span class="st">&#39;/path/to/file.pdf&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Note that if you enable this option in batch mode, it will cancel the entire batch!</p>
<p><a href="#table-of-contents">back to top</a></p>
<hr />
<h2 id="advanced">Advanced</h2>
<h4 id="updating-task-status">Updating Task Status</h4>
<p>The process function will be run in a context with <code>progress</code>, <code>finishBatch</code> and <code>failedBatch</code> functions.</p>
<p>The example below illustrates how you can use these:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">var</span> uploader <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (file<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-2" title="2">  <span class="kw">this</span>.<span class="at">failedBatch</span>(<span class="st">&#39;some_error&#39;</span>)</a>
<a class="sourceLine" id="cb26-3" title="3">  <span class="kw">this</span>.<span class="at">finishBatch</span>(result)</a>
<a class="sourceLine" id="cb26-4" title="4">  <span class="kw">this</span>.<span class="at">progressBatch</span>(bytesUploaded<span class="op">,</span> totalBytes<span class="op">,</span> <span class="st">&quot;uploading&quot;</span>)</a>
<a class="sourceLine" id="cb26-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-6" title="6"><span class="va">uploader</span>.<span class="at">on</span>(<span class="st">&#39;task_finish&#39;</span><span class="op">,</span> <span class="kw">function</span> (taskId<span class="op">,</span> result) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-7" title="7">  <span class="co">// Handle finished result</span></a>
<a class="sourceLine" id="cb26-8" title="8"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb26-9" title="9"><span class="va">uploader</span>.<span class="at">on</span>(<span class="st">&#39;task_failed&#39;</span><span class="op">,</span> <span class="kw">function</span> (taskId<span class="op">,</span> errorMessage) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-10" title="10">  <span class="co">// Handle error</span></a>
<a class="sourceLine" id="cb26-11" title="11"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb26-12" title="12"><span class="va">uploader</span>.<span class="at">on</span>(<span class="st">&#39;task_progress&#39;</span><span class="op">,</span> <span class="kw">function</span> (taskId<span class="op">,</span> completed<span class="op">,</span> total) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-13" title="13">  <span class="co">// Handle task progress</span></a>
<a class="sourceLine" id="cb26-14" title="14"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb26-15" title="15"></a>
<a class="sourceLine" id="cb26-16" title="16"><span class="va">uploader</span>.<span class="at">push</span>(<span class="st">&#39;/some/file.jpg&#39;</span>)</a>
<a class="sourceLine" id="cb26-17" title="17">  .<span class="at">on</span>(<span class="st">&#39;finish&#39;</span><span class="op">,</span> <span class="kw">function</span> (result) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-18" title="18">    <span class="co">// Handle upload result</span></a>
<a class="sourceLine" id="cb26-19" title="19">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb26-20" title="20">  .<span class="at">on</span>(<span class="st">&#39;failed&#39;</span><span class="op">,</span> <span class="kw">function</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-21" title="21">    <span class="co">// Handle error</span></a>
<a class="sourceLine" id="cb26-22" title="22">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb26-23" title="23">  .<span class="at">on</span>(<span class="st">&#39;progress&#39;</span><span class="op">,</span> <span class="kw">function</span> (progress) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-24" title="24">    <span class="co">// progress.eta - human readable string estimating time remaining</span></a>
<a class="sourceLine" id="cb26-25" title="25">    <span class="co">// progress.pct - % complete (out of 100)</span></a>
<a class="sourceLine" id="cb26-26" title="26">    <span class="co">// progress.complete - # completed so far</span></a>
<a class="sourceLine" id="cb26-27" title="27">    <span class="co">// progress.total - # for completion</span></a>
<a class="sourceLine" id="cb26-28" title="28">    <span class="co">// progress.message - status message</span></a>
<a class="sourceLine" id="cb26-29" title="29">  <span class="op">}</span>)</a></code></pre></div>
<h4 id="update-status-in-batch-mode-batchsize-1">Update Status in Batch mode (batchSize &gt; 1)</h4>
<p>You can also complete individual tasks in a batch by using <code>failedTask</code> and <code>finishTask</code> functions.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">var</span> uploader <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(<span class="kw">function</span> (files<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb27-2" title="2">  <span class="kw">this</span>.<span class="at">failedTask</span>(<span class="dv">0</span><span class="op">,</span> <span class="st">&#39;some_error&#39;</span>)         <span class="co">// files[0] has failed with &#39;some_error&#39;</span></a>
<a class="sourceLine" id="cb27-3" title="3">  <span class="kw">this</span>.<span class="at">finishTask</span>(<span class="dv">1</span><span class="op">,</span> result)               <span class="co">// files[1] has finished with {result}</span></a>
<a class="sourceLine" id="cb27-4" title="4">  <span class="kw">this</span>.<span class="at">progressTask</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="st">&quot;copying&quot;</span>) <span class="co">// files[2] is 30% done, currently copying</span></a>
<a class="sourceLine" id="cb27-5" title="5"><span class="op">},</span> <span class="op">{</span> <span class="dt">batchSize</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb27-6" title="6"><span class="va">uploader</span>.<span class="at">push</span>(<span class="st">&#39;/some/file1.jpg&#39;</span>)</a>
<a class="sourceLine" id="cb27-7" title="7"><span class="va">uploader</span>.<span class="at">push</span>(<span class="st">&#39;/some/file2.jpg&#39;</span>)</a>
<a class="sourceLine" id="cb27-8" title="8"><span class="va">uploader</span>.<span class="at">push</span>(<span class="st">&#39;/some/file3.jpg&#39;</span>)</a></code></pre></div>
<p>Note that if you use <em>-Task and </em>-Batch functions together, the batch functions will only apply to the tasks that have not yet finished/failed.</p>
<h4 id="queue-statistics">Queue Statistics</h4>
<p>You can inspect the queue at any given time to see information about how many items are queued, average queue time, success rate and total item processed.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-2" title="2"><span class="kw">var</span> stats <span class="op">=</span> <span class="va">q</span>.<span class="at">getStats</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb28-3" title="3"></a>
<a class="sourceLine" id="cb28-4" title="4"><span class="co">// stats.total = Total tasks processed</span></a>
<a class="sourceLine" id="cb28-5" title="5"><span class="co">// stats.average = Average process time</span></a>
<a class="sourceLine" id="cb28-6" title="6"><span class="co">// stats.successRate = % success (between 0 and 1)</span></a>
<a class="sourceLine" id="cb28-7" title="7"><span class="co">// stats.peak = Most tasks queued at any given point in time</span></a></code></pre></div>
<p><a href="#table-of-contents">back to top</a></p>
<hr />
<h2 id="storage">Storage</h2>
<h4 id="using-a-store">Using a store</h4>
<p>For your convenience, we have added compatibility for a few storage options.</p>
<p>By default, we are using an in-memory store that doesn’t persist. You can change to one of our other built in stores by passing in the <code>store</code> option.</p>
<h4 id="built-in-store">Built-in store</h4>
<p>Currently, we support the following stores:</p>
<ul>
<li>memory</li>
<li>sql (SQLite, PostgreSQL)</li>
</ul>
<h4 id="sqlite-store-npm-install-sqlite3">SQLite store (<code>npm install sqlite3</code>)</h4>
<pre><code>var q = new Queue(fn, {
  store: {
    type: &#39;sql&#39;,
    dialect: &#39;sqlite&#39;,
    path: &#39;/path/to/sqlite/file&#39;
  }
});</code></pre>
<h4 id="postgresql-store-npm-install-pg">PostgreSQL store (<code>npm install pg</code>)</h4>
<pre><code>var q = new Queue(fn, {
  store: {
    type: &#39;sql&#39;,
    dialect: &#39;postgres&#39;,
    host: &#39;localhost&#39;,
    port: 5432,
    username: &#39;username&#39;,
    password: &#39;password&#39;,
    dbname: &#39;template1&#39;,
    tableName: &#39;tasks&#39;
  }
});</code></pre>
<p>Please help us add support for more stores; contributions are welcome!</p>
<h4 id="custom-store">Custom Store</h4>
<p>Writing your own store is very easy; you just need to implement a few functions then call <code>queue.use(store)</code> on your store.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb31-1" title="1"><span class="kw">var</span> q <span class="op">=</span> <span class="kw">new</span> <span class="at">Queue</span>(fn<span class="op">,</span> <span class="op">{</span> <span class="dt">store</span><span class="op">:</span> myStore <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb32-1" title="1"><span class="va">q</span>.<span class="at">use</span>(myStore)<span class="op">;</span></a></code></pre></div>
<p>Your store needs the following functions:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb33-1" title="1"><span class="va">q</span>.<span class="at">use</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb33-2" title="2">  <span class="dt">connect</span><span class="op">:</span> <span class="kw">function</span> (cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb33-3" title="3">    <span class="co">// Connect to your db</span></a>
<a class="sourceLine" id="cb33-4" title="4">  <span class="op">},</span></a>
<a class="sourceLine" id="cb33-5" title="5">  <span class="dt">getTask</span><span class="op">:</span> <span class="kw">function</span> (taskId<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb33-6" title="6">    <span class="co">// Retrieves a task</span></a>
<a class="sourceLine" id="cb33-7" title="7">  <span class="op">},</span></a>
<a class="sourceLine" id="cb33-8" title="8">  <span class="dt">putTask</span><span class="op">:</span> <span class="kw">function</span> (taskId<span class="op">,</span> task<span class="op">,</span> priority<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb33-9" title="9">    <span class="co">// Save task with given priority</span></a>
<a class="sourceLine" id="cb33-10" title="10">  <span class="op">},</span></a>
<a class="sourceLine" id="cb33-11" title="11">  <span class="dt">takeFirstN</span><span class="op">:</span> <span class="kw">function</span> (n<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb33-12" title="12">    <span class="co">// Removes the first N items (sorted by priority and age)</span></a>
<a class="sourceLine" id="cb33-13" title="13">  <span class="op">},</span></a>
<a class="sourceLine" id="cb33-14" title="14">  <span class="dt">takeLastN</span><span class="op">:</span> <span class="kw">function</span> (n<span class="op">,</span> cb) <span class="op">{</span></a>
<a class="sourceLine" id="cb33-15" title="15">    <span class="co">// Removes the last N items (sorted by priority and recency)</span></a>
<a class="sourceLine" id="cb33-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb33-17" title="17"><span class="op">}</span>)</a></code></pre></div>
<p><a href="#table-of-contents">back to top</a></p>
<hr />
<h2 id="full-documentation">Full Documentation</h2>
<h4 id="new-queueprocess-options">new Queue(process, options)</h4>
<p>The first argument can be either the process function or the <code>options</code> object.</p>
<p>A process function is required, all other options are optional.</p>
<ul>
<li><code>process</code> - function to process tasks. Will be run with either one single task (if <code>batchSize</code> is 1) or as an array of at most <code>batchSize</code> items. The second argument will be a callback <code>cb(error, result)</code> that must be called regardless of success or failure.</li>
</ul>
<hr />
<ul>
<li><code>filter</code> - function to filter input. Will be run with <code>input</code> whatever was passed to <code>q.push()</code>. If you define this function, then you will be expected to call the callback <code>cb(error, task)</code>. If an error is sent in the callback then the input is rejected.</li>
<li><code>merge</code> - function to merge tasks with the same task ID. Will be run with <code>oldTask</code>, <code>newTask</code> and a callback <code>cb(error, mergedTask)</code>. If you define this function then the callback is expected to be called.</li>
<li><code>priority</code> - function to determine the priority of a task. Takes in a task and returns callback <code>cb(error, priority)</code>.</li>
<li><code>precondition</code> - function that runs a check before processing to ensure it can process the next batch. Takes a callback <code>cb(error, passOrFail)</code>.</li>
</ul>
<hr />
<ul>
<li><code>id</code> - The property to use as the task ID. This can be a string or a function (for more complicated IDs). The function <code>(task, cb)</code> and must call the callback with <code>cb(error, taskId)</code>.</li>
<li><code>cancelIfRunning</code> - If true, when a task with the same ID is running, its worker will be cancelled. Defaults to <code>false</code>.</li>
<li><code>autoResume</code> - If true, tasks in the store will automatically start processing once it connects to the store. Defaults to <code>true</code>.</li>
<li><code>failTaskOnProcessException</code> - If true, when the process function throws an error the batch fails. Defaults to <code>true</code>.</li>
<li><code>filo</code> - If true, tasks will be completed in a first in, last out order. Defaults to <code>false</code>.</li>
<li><code>batchSize</code> - The number of tasks (at most) that can be processed at once. Defaults to <code>1</code>.</li>
<li><code>batchDelay</code> - Number of milliseconds to delay before starting to popping items off the queue. Defaults to <code>0</code>.</li>
<li><code>batchDelayTimeout</code> - Number of milliseconds to wait for a new task to arrive before firing off the batch. Defaults to <code>Infinity</code>.</li>
<li><code>concurrent</code> - Number of workers that can be running at any given time. Defaults to <code>1</code>.</li>
<li><code>maxTimeout</code> - Number of milliseconds before a task is considered timed out. Defaults to <code>Infinity</code>.</li>
<li><code>afterProcessDelay</code> - Number of milliseconds to delay before processing the next batch of items. Defaults to <code>1</code>.</li>
<li><code>maxRetries</code> - Maximum number of attempts to retry on a failed task. Defaults to <code>0</code>.</li>
<li><code>retryDelay</code> - Number of milliseconds before retrying. Defaults to <code>0</code>.</li>
<li><code>storeMaxRetries</code> - Maximum number of attempts before giving up on the store. Defaults to <code>Infinity</code>.</li>
<li><code>storeRetryTimeout</code> - Number of milliseconds to delay before trying to connect to the store again. Defaults to <code>1000</code>.</li>
<li><code>preconditionRetryTimeout</code> - Number of milliseconds to delay before checking the precondition function again. Defaults to <code>1000</code>.</li>
<li><code>store</code> - Represents the options for the initial store. Can be an object containing <code>{ type: storeType, ... options ... }</code>, or the store instance itself.</li>
</ul>
<h4 id="methods-on-queue">Methods on Queue</h4>
<ul>
<li><code>push(task, cb)</code> - Push a task onto the queue, with an optional callback when it completes. Returns a <code>Ticket</code> object.</li>
<li><code>pause()</code> - Pauses the queue: tries to pause running tasks and prevents tasks from getting processed until resumed.</li>
<li><code>resume()</code> - Resumes the queue and its runnign tasks.</li>
<li><code>destroy(cb)</code> - Destroys the queue: closes the store, tries to clean up.</li>
<li><code>use(store)</code> - Sets the queue to read from and write to the given store.</li>
<li><code>getStats()</code> - Gets the aggregate stats for the queue. Returns an object with properties <code>successRate</code>, <code>peak</code>, <code>total</code> and <code>average</code>, representing the success rate on tasks, peak number of items queued, total number of items processed and average processing time, respectively.</li>
<li><code>resetStats()</code> - Resets all of the aggregate stats.</li>
</ul>
<h4 id="events-on-queue">Events on Queue</h4>
<ul>
<li><code>task_queued</code> - When a task is queued</li>
<li><code>task_accepted</code> - When a task is accepted</li>
<li><code>task_started</code> - When a task begins processing</li>
<li><code>task_finish</code> - When a task is completed</li>
<li><code>task_failed</code> - When a task fails</li>
<li><code>task_progress</code> - When a task progress changes</li>
<li><code>batch_finish</code> - When a batch of tasks (or worker) completes</li>
<li><code>batch_failed</code> - When a batch of tasks (or worker) fails</li>
<li><code>batch_progress</code> - When a batch of tasks (or worker) updates its progress</li>
</ul>
<h4 id="events-on-ticket">Events on Ticket</h4>
<ul>
<li><code>accept</code> - When the corresponding task is accepted (has passed filter)</li>
<li><code>queued</code> - When the corresponding task is queued (and saved into the store)</li>
<li><code>started</code> - When the corresponding task is started</li>
<li><code>progress</code> - When the corresponding task progress changes</li>
<li><code>finish</code> - When the corresponding task completes</li>
<li><code>failed</code> - When the corresponding task fails</li>
</ul>
</body>
</html>
