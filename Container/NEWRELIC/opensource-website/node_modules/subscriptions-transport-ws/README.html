<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="graphql-ws">graphql-ws</h1>
<p>The <code>subscriptions-transport-ws</code> library is not being actively maintained. It is recommended that you use the <a href="https://github.com/enisdenjo/graphql-ws">graphql-ws</a> library instead. For details read the <a href="https://the-guild.dev/blog/graphql-over-websockets">GraphQL over WebSockets</a> announcement.</p>
<h1 id="subscriptions-transport-ws">subscriptions-transport-ws</h1>
<p><a href="https://badge.fury.io/js/subscriptions-transport-ws"><img src="https://badge.fury.io/js/subscriptions-transport-ws.svg" alt="npm version" /></a> <a href="https://github.com/apollostack/subscriptions-transport-ws/blob/license/LICENSE"><img src="https://img.shields.io/github/license/apollostack/subscriptions-transport-ws.svg" alt="GitHub license" /></a></p>
<p><strong>(Work in progress!)</strong></p>
<p>A GraphQL WebSocket server and client to facilitate GraphQL queries, mutations and subscriptions over WebSocket.</p>
<blockquote>
<p><code>subscriptions-transport-ws</code> is an extension for GraphQL, and you can use it with any GraphQL client and server (not only Apollo).</p>
</blockquote>
<p>See <a href="https://github.com/apollostack/GitHunt-API">GitHunt-API</a> and <a href="https://github.com/apollostack/GitHunt-React">GitHunt-React</a> for an example server and client integration.</p>
<h1 id="getting-started">Getting Started</h1>
<p>Start by installing the package, using Yarn or NPM.</p>
<pre><code>Using Yarn:
$ yarn add subscriptions-transport-ws

Or, using NPM:
$ npm install --save subscriptions-transport-ws</code></pre>
<blockquote>
<p>Note that you need to use this package on both GraphQL client and server.</p>
</blockquote>
<blockquote>
<p>This command also installs this package’s dependencies, including <code>graphql-subscriptions</code>.</p>
</blockquote>
<h2 id="server">Server</h2>
<p>Starting with the server, create a new simple <code>PubSub</code> instance. We will later use this <code>PubSub</code> to publish and subscribe to data changes.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="im">import</span> <span class="op">{</span> PubSub <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;graphql-subscriptions&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="im">export</span> <span class="kw">const</span> pubsub <span class="op">=</span> <span class="kw">new</span> <span class="at">PubSub</span>()<span class="op">;</span></a></code></pre></div>
<p>Now, create <code>SubscriptionServer</code> instance, with your GraphQL <code>schema</code>, <code>execute</code> and <code>subscribe</code> (from <code>graphql-js</code> package):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="im">import</span> <span class="op">{</span> createServer <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;http&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="im">import</span> <span class="op">{</span> SubscriptionServer <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;subscriptions-transport-ws&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="im">import</span> <span class="op">{</span> execute<span class="op">,</span> subscribe <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;graphql&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="im">import</span> <span class="op">{</span> schema <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;./my-schema&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="kw">const</span> WS_PORT <span class="op">=</span> <span class="dv">5000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-7" title="7"></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">// Create WebSocket listener server</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="kw">const</span> websocketServer <span class="op">=</span> <span class="at">createServer</span>((request<span class="op">,</span> response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-10" title="10">  <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">404</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-11" title="11">  <span class="va">response</span>.<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-13" title="13"></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">// Bind it to port and start listening</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="va">websocketServer</span>.<span class="at">listen</span>(WS_PORT<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(</a>
<a class="sourceLine" id="cb3-16" title="16">  <span class="vs">`Websocket Server is now running on http://localhost:</span><span class="sc">${</span>WS_PORT<span class="sc">}</span><span class="vs">`</span></a>
<a class="sourceLine" id="cb3-17" title="17">))<span class="op">;</span></a>
<a class="sourceLine" id="cb3-18" title="18"></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="kw">const</span> subscriptionServer <span class="op">=</span> <span class="va">SubscriptionServer</span>.<span class="at">create</span>(</a>
<a class="sourceLine" id="cb3-20" title="20">  <span class="op">{</span></a>
<a class="sourceLine" id="cb3-21" title="21">    schema<span class="op">,</span></a>
<a class="sourceLine" id="cb3-22" title="22">    execute<span class="op">,</span></a>
<a class="sourceLine" id="cb3-23" title="23">    subscribe<span class="op">,</span></a>
<a class="sourceLine" id="cb3-24" title="24">  <span class="op">},</span></a>
<a class="sourceLine" id="cb3-25" title="25">  <span class="op">{</span></a>
<a class="sourceLine" id="cb3-26" title="26">    <span class="dt">server</span><span class="op">:</span> websocketServer<span class="op">,</span></a>
<a class="sourceLine" id="cb3-27" title="27">    <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/graphql&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-28" title="28">  <span class="op">},</span></a>
<a class="sourceLine" id="cb3-29" title="29">)<span class="op">;</span></a></code></pre></div>
<h3 id="creating-your-subscriptions">Creating Your Subscriptions</h3>
<p>Please refer to <a href="https://github.com/apollographql/graphql-subscriptions"><code>graphql-subscriptions</code></a> documentation for how to create your GraphQL subscriptions, and how to publish data.</p>
<h2 id="client-browser">Client (browser)</h2>
<p>When using this package for client side, you can choose either use HTTP request for Queries and Mutation and use the WebSocket for subscriptions only, or create a full transport that handles all type of GraphQL operations over the socket.</p>
<h3 id="full-websocket-transport">Full WebSocket Transport</h3>
<p>To start with a full WebSocket transport, that handles all types of GraphQL operations, import and create an instance of <code>SubscriptionClient</code>.</p>
<p>Then, create your <code>ApolloClient</code> instance and use the <code>SubscriptionsClient</code> instance as network interface:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="im">import</span> <span class="op">{</span> SubscriptionClient <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;subscriptions-transport-ws&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="im">import</span> ApolloClient <span class="im">from</span> <span class="st">&#39;apollo-client&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">const</span> GRAPHQL_ENDPOINT <span class="op">=</span> <span class="st">&#39;ws://localhost:3000/graphql&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-5" title="5"></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="at">SubscriptionClient</span>(GRAPHQL_ENDPOINT<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="dt">reconnect</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-9" title="9"></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">const</span> apolloClient <span class="op">=</span> <span class="kw">new</span> <span class="at">ApolloClient</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb4-11" title="11">    <span class="dt">networkInterface</span><span class="op">:</span> client<span class="op">,</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h3 id="hybrid-websocket-transport">Hybrid WebSocket Transport</h3>
<p>To start with a hybrid WebSocket transport, that handles only <code>subscription</code>s over WebSocket, create your <code>SubscriptionClient</code> and a regular HTTP network interface, then extend your network interface to use the WebSocket client for GraphQL subscriptions:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="im">import</span> <span class="op">{</span>SubscriptionClient<span class="op">,</span> addGraphQLSubscriptions<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;subscriptions-transport-ws&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="im">import</span> ApolloClient<span class="op">,</span> <span class="op">{</span>createNetworkInterface<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;apollo-client&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co">// Create regular NetworkInterface by using apollo-client&#39;s API:</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="kw">const</span> networkInterface <span class="op">=</span> <span class="at">createNetworkInterface</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb5-6" title="6"> <span class="dt">uri</span><span class="op">:</span> <span class="st">&#39;http://localhost:3000&#39;</span> <span class="co">// Your GraphQL endpoint</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="co">// Create WebSocket client</span></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="kw">const</span> wsClient <span class="op">=</span> <span class="kw">new</span> <span class="at">SubscriptionClient</span>(<span class="vs">`ws://localhost:5000/`</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="dt">reconnect</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="dt">connectionParams</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-13" title="13">        <span class="co">// Pass any arguments you want for initialization</span></a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-16" title="16"></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="co">// Extend the network interface with the WebSocket</span></a>
<a class="sourceLine" id="cb5-18" title="18"><span class="kw">const</span> networkInterfaceWithSubscriptions <span class="op">=</span> <span class="at">addGraphQLSubscriptions</span>(</a>
<a class="sourceLine" id="cb5-19" title="19">    networkInterface<span class="op">,</span></a>
<a class="sourceLine" id="cb5-20" title="20">    wsClient</a>
<a class="sourceLine" id="cb5-21" title="21">)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-22" title="22"></a>
<a class="sourceLine" id="cb5-23" title="23"><span class="co">// Finally, create your ApolloClient instance with the modified network interface</span></a>
<a class="sourceLine" id="cb5-24" title="24"><span class="kw">const</span> apolloClient <span class="op">=</span> <span class="kw">new</span> <span class="at">ApolloClient</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb5-25" title="25">    <span class="dt">networkInterface</span><span class="op">:</span> networkInterfaceWithSubscriptions</a>
<a class="sourceLine" id="cb5-26" title="26"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now, when you want to use subscriptions in client side, use your <code>ApolloClient</code> instance, with <a href="https://www.apollographql.com/docs/react/api/apollo-client#ApolloClient.subscribe"><code>subscribe</code></a> or <code>query</code> <a href="https://www.apollographql.com/docs/react/api/apollo-client#ObservableQuery.subscribeToMore"><code>subscribeToMore</code></a>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="va">apolloClient</span>.<span class="at">subscribe</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="dt">query</span><span class="op">:</span> gql<span class="vs">`</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="vs">    subscription onNewItem {</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="vs">        newItemCreated {</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="vs">            id</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="vs">        }</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="vs">    }`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="dt">variables</span><span class="op">:</span> <span class="op">{}</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="op">}</span>).<span class="at">subscribe</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb6-10" title="10">  <span class="at">next</span> (data) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-11" title="11">    <span class="co">// Notify your application with the new arrived data</span></a>
<a class="sourceLine" id="cb6-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="va">apolloClient</span>.<span class="at">query</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="dt">query</span><span class="op">:</span> ITEM_LIST_QUERY<span class="op">,</span></a>
<a class="sourceLine" id="cb7-3" title="3">  <span class="dt">variables</span><span class="op">:</span> <span class="op">{}</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="op">}</span>).<span class="at">subscribeToMore</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb7-5" title="5">  <span class="dt">document</span><span class="op">:</span> gql<span class="vs">`</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="vs">    subscription onNewItem {</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="vs">        newItemCreated {</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="vs">            id</span></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="vs">        }</span></a>
<a class="sourceLine" id="cb7-10" title="10"><span class="vs">    }`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="dt">variables</span><span class="op">:</span> <span class="op">{},</span></a>
<a class="sourceLine" id="cb7-12" title="12">  <span class="dt">updateQuery</span><span class="op">:</span> (prev<span class="op">,</span> <span class="op">{</span> subscriptionData<span class="op">,</span> variables <span class="op">}</span>) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-13" title="13">    <span class="co">// Perform updates on previousResult with subscriptionData</span></a>
<a class="sourceLine" id="cb7-14" title="14">    <span class="cf">return</span> updatedResult<span class="op">;</span></a>
<a class="sourceLine" id="cb7-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb7-16" title="16"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>If you don’t use any package/modules loader, you can still use this package, by using <code>unpkg</code> service, and get the client side package from:</p>
<pre><code>https://unpkg.com/subscriptions-transport-ws@VERSION/browser/client.js</code></pre>
<blockquote>
<p>Replace VERSION with the latest version of the package.</p>
</blockquote>
<h2 id="use-it-with-graphiql">Use it with GraphiQL</h2>
<p>You can use this package’s power with GraphiQL, and subscribe to live-data stream inside GraphiQL.</p>
<p>If you are using the latest version of <code>graphql-server</code> flavors (<code>graphql-server-express</code>, <code>graphql-server-koa</code>, etc…), you already can use it! Make sure to specify <code>subscriptionsEndpoint</code> in GraphiQL configuration, and that’s it!</p>
<p>For example, <code>graphql-server-express</code> users need to add the following:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/graphiql&#39;</span><span class="op">,</span> <span class="at">graphiqlExpress</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="dt">endpointURL</span><span class="op">:</span> <span class="st">&#39;/graphql&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="dt">subscriptionsEndpoint</span><span class="op">:</span> <span class="vs">`YOUR_SUBSCRIPTION_ENDPOINT_HERE`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>If you are using older version, or another GraphQL server, start by modifying GraphiQL static HTML, and add this package and it’s fetcher from CDN:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb10-1" title="1">    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;//unpkg.com/subscriptions-transport-ws@0.5.4/browser/client.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></a>
<a class="sourceLine" id="cb10-2" title="2">    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;//unpkg.com/graphiql-subscriptions-fetcher@0.0.2/browser/client.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></a></code></pre></div>
<p>Then, create <code>SubscriptionClient</code> and define the fetcher:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">let</span> subscriptionsClient <span class="op">=</span> <span class="kw">new</span> <span class="va">window</span>.<span class="va">SubscriptionsTransportWs</span>.<span class="at">SubscriptionClient</span>(<span class="st">&#39;SUBSCRIPTION_WS_URL_HERE&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="dt">reconnect</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="kw">let</span> myCustomFetcher <span class="op">=</span> <span class="va">window</span>.<span class="va">GraphiQLSubscriptionsFetcher</span>.<span class="at">graphQLFetcher</span>(subscriptionsClient<span class="op">,</span> graphQLFetcher)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p><code>graphQLFetcher</code> is the default fetcher, and we use it as fallback for non-subscription GraphQL operations.</p>
</blockquote>
<p>And replace your GraphiQL creation logic to use the new fetcher:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="va">ReactDOM</span>.<span class="at">render</span>(</a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="va">React</span>.<span class="at">createElement</span>(GraphiQL<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-3" title="3">    <span class="dt">fetcher</span><span class="op">:</span> myCustomFetcher<span class="op">,</span> <span class="co">// &lt;-- here</span></a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="dt">onEditQuery</span><span class="op">:</span> onEditQuery<span class="op">,</span></a>
<a class="sourceLine" id="cb12-5" title="5">    <span class="dt">onEditVariables</span><span class="op">:</span> onEditVariables<span class="op">,</span></a>
<a class="sourceLine" id="cb12-6" title="6">    <span class="dt">onEditOperationName</span><span class="op">:</span> onEditOperationName<span class="op">,</span></a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="dt">query</span><span class="op">:</span> $<span class="op">{</span><span class="at">safeSerialize</span>(queryString)<span class="op">},</span></a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="dt">response</span><span class="op">:</span> $<span class="op">{</span><span class="at">safeSerialize</span>(resultString)<span class="op">},</span></a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="dt">variables</span><span class="op">:</span> $<span class="op">{</span><span class="at">safeSerialize</span>(variablesString)<span class="op">},</span></a>
<a class="sourceLine" id="cb12-10" title="10">    <span class="dt">operationName</span><span class="op">:</span> $<span class="op">{</span><span class="at">safeSerialize</span>(operationName)<span class="op">},</span></a>
<a class="sourceLine" id="cb12-11" title="11">  <span class="op">}</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb12-12" title="12">  <span class="va">document</span>.<span class="at">body</span></a>
<a class="sourceLine" id="cb12-13" title="13">)<span class="op">;</span></a></code></pre></div>
<h1 id="api-docs">API Docs</h1>
<h2 id="subscriptionclient">SubscriptionClient</h2>
<h3 id="constructorurl-options-websocketimpl"><code>Constructor(url, options, webSocketImpl)</code></h3>
<ul>
<li><code>url: string</code> : url that the client will connect to, starts with <code>ws://</code> or <code>wss://</code></li>
<li><code>options?: Object</code> : optional, object to modify default client behavior
<ul>
<li><code>timeout?: number</code> : how long the client should wait in ms for a keep-alive message from the server (default 30000 ms), this parameter is ignored if the server does not send keep-alive messages. This will also be used to calculate the max connection time per connect/reconnect</li>
<li><code>minTimeout?: number</code>: the minimum amount of time the client should wait for a connection to be made (default 1000 ms)</li>
<li><code>lazy?: boolean</code> : use to set lazy mode - connects only when first subscription created, and delay the socket initialization</li>
<li><code>connectionParams?: Object | Function | Promise&lt;Object&gt;</code> : object that will be available as first argument of <code>onConnect</code> (in server side), if passed a function - it will call it and send the return value, if function returns as promise - it will wait until it resolves and send the resolved value.</li>
<li><code>reconnect?: boolean</code> : automatic reconnect in case of connection error</li>
<li><code>reconnectionAttempts?: number</code> : how much reconnect attempts</li>
<li><code>connectionCallback?: (error) =&gt; {}</code> : optional, callback that called after the first init message, with the error (if there is one)</li>
<li><code>inactivityTimeout?: number</code> : how long the client should wait in ms, when there are no active subscriptions, before disconnecting from the server. Set to 0 to disable this behavior. (default 0)</li>
</ul></li>
<li><code>webSocketImpl?: Object</code> - optional, constructor for W3C compliant WebSocket implementation. Use this when your environment does not have a built-in native WebSocket (for example, with NodeJS client)</li>
</ul>
<h3 id="methods">Methods</h3>
<h4 id="requestoptions-observableexecutionresult-returns-observable-to-execute-the-operation."><code>request(options) =&gt; Observable&lt;ExecutionResult&gt;</code>: returns observable to execute the operation.</h4>
<ul>
<li><code>options: {OperationOptions}</code>
<ul>
<li><code>query: string</code> : GraphQL subscription</li>
<li><code>variables: Object</code> : GraphQL subscription variables</li>
<li><code>operationName: string</code> : operation name of the subscription</li>
<li><code>context: Object</code> : use to override context for a specific call</li>
</ul></li>
</ul>
<h4 id="unsubscribeall-void---unsubscribes-from-all-active-subscriptions."><code>unsubscribeAll() =&gt; void</code> - unsubscribes from all active subscriptions.</h4>
<h4 id="oneventname-callback-thiscontext-function"><code>on(eventName, callback, thisContext) =&gt; Function</code></h4>
<ul>
<li><code>eventName: string</code>: the name of the event, available events are: <code>connecting</code>, <code>connected</code>, <code>reconnecting</code>, <code>reconnected</code>, <code>disconnected</code> and <code>error</code></li>
<li><code>callback: Function</code>: function to be called when websocket connects and initialized.</li>
<li><code>thisContext: any</code>: <code>this</code> context to use when calling the callback function.</li>
<li>=&gt; Returns an <code>off</code> method to cancel the event subscription.</li>
</ul>
<h4 id="onconnectedcallback-thiscontext-function---shorthand-for-.onconnected-..."><code>onConnected(callback, thisContext) =&gt; Function</code> - shorthand for <code>.on('connected', ...)</code></h4>
<ul>
<li><code>callback: Function(payload)</code>: function to be called when websocket connects and initialized, after ACK message returned from the server. Includes payload from server, if any.</li>
<li><code>thisContext: any</code>: <code>this</code> context to use when calling the callback function.</li>
<li>=&gt; Returns an <code>off</code> method to cancel the event subscription.</li>
</ul>
<h4 id="onreconnectedcallback-thiscontext-function---shorthand-for-.onreconnected-..."><code>onReconnected(callback, thisContext) =&gt; Function</code> - shorthand for <code>.on('reconnected', ...)</code></h4>
<ul>
<li><code>callback: Function(payload)</code>: function to be called when websocket reconnects and initialized, after ACK message returned from the server. Includes payload from server, if any.</li>
<li><code>thisContext: any</code>: <code>this</code> context to use when calling the callback function.</li>
<li>=&gt; Returns an <code>off</code> method to cancel the event subscription.</li>
</ul>
<h4 id="onconnectingcallback-thiscontext-function---shorthand-for-.onconnecting-..."><code>onConnecting(callback, thisContext) =&gt; Function</code> - shorthand for <code>.on('connecting', ...)</code></h4>
<ul>
<li><code>callback: Function</code>: function to be called when websocket starts it’s connection</li>
<li><code>thisContext: any</code>: <code>this</code> context to use when calling the callback function.</li>
<li>=&gt; Returns an <code>off</code> method to cancel the event subscription.</li>
</ul>
<h4 id="onreconnectingcallback-thiscontext-function---shorthand-for-.onreconnecting-..."><code>onReconnecting(callback, thisContext) =&gt; Function</code> - shorthand for <code>.on('reconnecting', ...)</code></h4>
<ul>
<li><code>callback: Function</code>: function to be called when websocket starts it’s reconnection</li>
<li><code>thisContext: any</code>: <code>this</code> context to use when calling the callback function.</li>
<li>=&gt; Returns an <code>off</code> method to cancel the event subscription.</li>
</ul>
<h4 id="ondisconnectedcallback-thiscontext-function---shorthand-for-.ondisconnected-..."><code>onDisconnected(callback, thisContext) =&gt; Function</code> - shorthand for <code>.on('disconnected', ...)</code></h4>
<ul>
<li><code>callback: Function</code>: function to be called when websocket disconnected.</li>
<li><code>thisContext: any</code>: <code>this</code> context to use when calling the callback function.</li>
<li>=&gt; Returns an <code>off</code> method to cancel the event subscription.</li>
</ul>
<h4 id="onerrorcallback-thiscontext-function---shorthand-for-.onerror-..."><code>onError(callback, thisContext) =&gt; Function</code> - shorthand for <code>.on('error', ...)</code></h4>
<ul>
<li><code>callback: Function</code>: function to be called when an error occurs.</li>
<li><code>thisContext: any</code>: <code>this</code> context to use when calling the callback function.</li>
<li>=&gt; Returns an <code>off</code> method to cancel the event subscription.</li>
</ul>
<h3 id="close-void---closes-the-websocket-connection-manually-and-ignores-reconnect-logic-if-it-was-set-to-true."><code>close() =&gt; void</code> - closes the WebSocket connection manually, and ignores <code>reconnect</code> logic if it was set to <code>true</code>.</h3>
<h3 id="usemiddlewares-middlewareinterface-subscriptionclient---adds-middleware-to-modify-operationoptions-per-each-request"><code>use(middlewares: MiddlewareInterface[]) =&gt; SubscriptionClient</code> - adds middleware to modify <code>OperationOptions</code> per each request</h3>
<ul>
<li><code>middlewares: MiddlewareInterface[]</code> - Array contains list of middlewares (implemented <code>applyMiddleware</code> method) implementation, the <code>SubscriptionClient</code> will use the middlewares to modify <code>OperationOptions</code> for every operation</li>
</ul>
<h3 id="status-number-returns-the-current-sockets-readystate"><code>status: number</code> : returns the current socket’s <code>readyState</code></h3>
<h2 id="subscriptionserver">SubscriptionServer</h2>
<h3 id="constructoroptions-socketoptions-socketserver"><code>Constructor(options, socketOptions | socketServer)</code></h3>
<ul>
<li><code>options: {ServerOptions}</code>
<ul>
<li><code>rootValue?: any</code> : Root value to use when executing GraphQL root operations</li>
<li><code>schema?: GraphQLSchema</code> : GraphQL schema object. If not provided, you have to return the schema as a property on the object returned from <code>onOperation</code>.</li>
<li><code>execute?: (schema, document, rootValue, contextValue, variableValues, operationName) =&gt; Promise&lt;ExecutionResult&gt; | AsyncIterator&lt;ExecutionResult&gt;</code> : GraphQL <code>execute</code> function, provide the default one from <code>graphql</code> package. Return value of <code>AsyncItrator</code> is also valid since this package also support reactive <code>execute</code> methods.</li>
<li><code>subscribe?: (schema, document, rootValue, contextValue, variableValues, operationName) =&gt; Promise&lt;ExecutionResult | AsyncIterator&lt;ExecutionResult&gt;&gt;</code> : GraphQL <code>subscribe</code> function, provide the default one from <code>graphql</code> package.</li>
<li><code>onOperation?: (message: SubscribeMessage, params: ExecutionParams, webSocket: WebSocket)</code> : optional method to create custom params that will be used when resolving this operation. It can also be used to dynamically resolve the schema that will be used for the particular operation.</li>
<li><code>onOperationComplete?: (webSocket: WebSocket, opId: string)</code> : optional method that called when a GraphQL operation is done (for query and mutation it’s immediately, and for subscriptions when unsubscribing)</li>
<li><code>onConnect?: (connectionParams: Object, webSocket: WebSocket, context: ConnectionContext)</code> : optional method that called when a client connects to the socket, called with the <code>connectionParams</code> from the client, if the return value is an object, its elements will be added to the context. return <code>false</code> or throw an exception to reject the connection. May return a Promise.</li>
<li><code>onDisconnect?: (webSocket: WebSocket, context: ConnectionContext)</code> : optional method that called when a client disconnects</li>
<li><code>keepAlive?: number</code> : optional interval in ms to send <code>KEEPALIVE</code> messages to all clients</li>
</ul></li>
<li><code>socketOptions: {WebSocket.IServerOptions}</code> : options to pass to the WebSocket object (full docs <a href="https://github.com/websockets/ws/blob/master/doc/ws.md">here</a>)
<ul>
<li><code>server?: HttpServer</code> - existing HTTP server to use (use without <code>host</code>/<code>port</code>)</li>
<li><code>host?: string</code> - server host</li>
<li><code>port?: number</code> - server port</li>
<li><code>path?: string</code> - endpoint path</li>
</ul></li>
<li><code>socketServer: {WebSocket.Server}</code> : a configured server if you need more control. Can be used for integration testing with in-memory WebSocket implementation.</li>
</ul>
<h2 id="how-it-works">How it works?</h2>
<ul>
<li>For GraphQL WebSocket protocol docs, <a href="https://github.com/apollographql/subscriptions-transport-ws/blob/master/PROTOCOL.md">click here</a></li>
<li>This package also uses <code>AsyncIterator</code> internally using <a href="https://github.com/leebyron/iterall">iterall</a>, for more information <a href="https://github.com/ReactiveX/IxJS">click here</a>, or <a href="https://github.com/tc39/proposal-async-iteration">the proposal</a></li>
</ul>
<p>The current version of this transport, also support a previous version of the protocol.</p>
<p><a href="https://github.com/apollographql/subscriptions-transport-ws/blob/cacb8692f3601344a4101d802443d046d73f8b23/README.md#client-server-communication">You can find the old protocol docs here</a></p>
</body>
</html>
