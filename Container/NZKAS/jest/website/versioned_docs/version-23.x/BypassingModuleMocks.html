<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>Bypassing module mocks</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
    <style type="text/css">
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ff0000;
        font-weight: bold;
      } /* Alert */
      code span.an {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #7d9029;
      } /* Attribute */
      code span.bn {
        color: #40a070;
      } /* BaseN */
      code span.bu {
      } /* BuiltIn */
      code span.cf {
        color: #007020;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4070a0;
      } /* Char */
      code span.cn {
        color: #880000;
      } /* Constant */
      code span.co {
        color: #60a0b0;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #ba2121;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #902000;
      } /* DataType */
      code span.dv {
        color: #40a070;
      } /* DecVal */
      code span.er {
        color: #ff0000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #40a070;
      } /* Float */
      code span.fu {
        color: #06287e;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #007020;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #666666;
      } /* Operator */
      code span.ot {
        color: #007020;
      } /* Other */
      code span.pp {
        color: #bc7a00;
      } /* Preprocessor */
      code span.sc {
        color: #4070a0;
      } /* SpecialChar */
      code span.ss {
        color: #bb6688;
      } /* SpecialString */
      code span.st {
        color: #4070a0;
      } /* String */
      code span.va {
        color: #19177c;
      } /* Variable */
      code span.vs {
        color: #4070a0;
      } /* VerbatimString */
      code span.wa {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">Bypassing module mocks</h1>
    </header>
    <p>
      Jest allows you to mock out whole modules in your tests, which can be
      useful for testing your code is calling functions from that module
      correctly. However, sometimes you may want to use parts of a mocked module
      in your <em>test file</em>, in which case you want to access the original
      implementation, rather than a mocked version.
    </p>
    <p>
      Consider writing a test case for this <code>createUser</code> function:
    </p>
    <div class="sourceCode" id="cb1">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// createUser.js</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="im">import</span> fetch <span class="im">from</span> <span class="st">&#39;node-fetch&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="im">export</span> <span class="kw">const</span> createUser <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&#39;http://website.com/users&#39;</span><span class="op">,</span> <span class="op">{</span><span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-6" title="6">  <span class="kw">const</span> userId <span class="op">=</span> <span class="cf">await</span> <span class="va">response</span>.<span class="at">text</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="cf">return</span> userId<span class="op">;</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="op">};</span></a></code></pre>
    </div>
    <p>
      Your test will want to mock the <code>fetch</code> function so that we can
      be sure that it gets called without actually making the network request.
      However, you’ll also need to mock the return value of
      <code>fetch</code> with a <code>Response</code> (wrapped in a
      <code>Promise</code>), as our function uses it to grab the created user’s
      ID. So you might initially try writing a test like this:
    </p>
    <div class="sourceCode" id="cb2">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">jest</span>.<span class="at">mock</span>(<span class="st">&#39;node-fetch&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="im">import</span> fetch<span class="op">,</span> <span class="op">{</span>Response<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;node-fetch&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-4" title="4"></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="im">import</span> <span class="op">{</span>createUser<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;./createUser&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="at">test</span>(<span class="st">&#39;createUser calls fetch with the right args and returns the user id&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" title="8">  <span class="va">fetch</span>.<span class="at">mockReturnValue</span>(<span class="va">Promise</span>.<span class="at">resolve</span>(<span class="kw">new</span> <span class="at">Response</span>(<span class="st">&#39;4&#39;</span>)))<span class="op">;</span></a>
<a class="sourceLine" id="cb2-9" title="9"></a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="kw">const</span> userId <span class="op">=</span> <span class="cf">await</span> <span class="at">createUser</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb2-11" title="11"></a>
<a class="sourceLine" id="cb2-12" title="12">  <span class="at">expect</span>(fetch).<span class="at">toHaveBeenCalledTimes</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-13" title="13">  <span class="at">expect</span>(fetch).<span class="at">toHaveBeenCalledWith</span>(<span class="st">&#39;http://website.com/users&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-15" title="15">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-16" title="16">  <span class="at">expect</span>(userId).<span class="at">toBe</span>(<span class="st">&#39;4&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-17" title="17"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>
      However, if you ran that test you would find that the
      <code>createUser</code> function would fail, throwing the error:
      <code>TypeError: response.text is not a function</code>. This is because
      the <code>Response</code> class you’ve imported from
      <code>node-fetch</code> has been mocked (due to the
      <code>jest.mock</code> call at the top of the test file) so it no longer
      behaves the way it should.
    </p>
    <p>
      To get around problems like this, Jest provides the
      <code>jest.requireActual</code> helper. To make the above test work, make
      the following change to the imports in the test file:
    </p>
    <div class="sourceCode" id="cb3">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// BEFORE</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="va">jest</span>.<span class="at">mock</span>(<span class="st">&#39;node-fetch&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="im">import</span> fetch<span class="op">,</span> <span class="op">{</span>Response<span class="op">}</span> <span class="im">from</span> <span class="st">&#39;node-fetch&#39;</span><span class="op">;</span></a></code></pre>
    </div>
    <div class="sourceCode" id="cb4">
      <pre
        class="sourceCode javascript"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="co">// AFTER</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="va">jest</span>.<span class="at">mock</span>(<span class="st">&#39;node-fetch&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="im">import</span> fetch <span class="im">from</span> <span class="st">&#39;node-fetch&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">const</span> <span class="op">{</span>Response<span class="op">}</span> <span class="op">=</span> <span class="va">jest</span>.<span class="at">requireActual</span>(<span class="st">&#39;node-fetch&#39;</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>
      This allows your test file to import the actual
      <code>Response</code> object from <code>node-fetch</code>, rather than a
      mocked version. This means the test will now pass correctly.
    </p>
  </body>
</html>
