<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>2017-05-06-jest-20-delightful-testing-multi-project-runner</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<p>A few months ago we announced <a href="https://jestjs.io/blog/2017/02/21/jest-19-immersive-watch-mode-test-platform-improvements.html">Jest 19</a> which came with major new features and was the biggest Jest release until today. Jest 20 has twice the amount of changes compared to the previous version, features a complete rewrite of the test runner, adds new testing APIs. The new release enables a new level of customization and configuration for projects all while making it effortless to upgrade. Beyond Painless JavaScript Testing, we believe Jest is now delivering a <strong>Delightful JavaScript Testing experience</strong>. Let’s take a look at the best new features and changes in depth:</p>
<h2 id="multi-project-runner-configuration-overhaul">Multi-Project-Runner &amp; Configuration Overhaul</h2>
<p>Until now, Jest could only operate in one project at a time. This is often cumbersome if you are working on many smaller projects that each have their own setup and configuration. With Jest 20, we rewrote the test runner completely to run many projects at the same time within a single instance of Jest, for example if you are working on a React frontend and a node.js backend. Here is a video of Jest running tests for <a href="https://github.com/facebook/react">React</a>, <a href="https://github.com/facebook/relay">Relay</a>, <a href="https://github.com/yarnpkg/yarn">Yarn</a> and Jest all at the same time:</p>
<figure>
<img src="/img/blog/20-multi-runner.gif" alt="multi-runner" /><figcaption>multi-runner</figcaption>
</figure>
<!--truncate-->
<p>Jest is now collapsing the usage guide after the first test run to save vertical space in the terminal.</p>
<p>Further, we completely overhauled how the configuration system works inside of Jest. You can now pass any configuration option through the CLI to overwrite the ones specified in your configuration file. Along with that, we changed Jest to look for a <code>jest.config.js</code> file by default which means you are now able to define a Jest configuration using JavaScript as well as being able to configure it through <code>package.json</code> like before. Through the addition of all these new features, you are now able to combine Jest in more powerful ways than ever before. For example, if you would like to find out which tests Jest would run given a set of changed files from a commit across multiple projects in a monorepo, you can combine cli arguments like this now:</p>
<pre><code>$ jest --projects projectA projectB --listTests --findRelatedTests projectA/banana.js projectB/kiwi.js
[
  &quot;projectA/banana.test.js&quot;,
  &quot;projectB/kiwi.test.js&quot;,
  &quot;projectB/pineapple.test.js&quot;,
]</code></pre>
<p>This is especially useful for continuous integration (CI) systems where you may want to only run a subset of tests for Pull Requests to prevent Jest from running thousands of test files on every small change.</p>
<p>Finally, we are now properly mapping code coverage when using TypeScript and we are running code coverage for untested files in worker processes which yields significant speed ups for this feature.</p>
<h2 id="new-improved-testing-apis">New &amp; Improved Testing APIs</h2>
<p>We made a number of additions and improvements to the testing APIs which will help write more effective tests. We’d like to point out that all of these improvements were made entirely by community members!</p>
<ul>
<li><strong>Better async testing:</strong> Added new async/Promise support through resolves/rejects modifiers on expect: <code>expect(Promise(…)).resolves.toEqual(…)</code>. <a href="https://jestjs.io/docs/en/expect.html#resolves">See documentation</a>.</li>
<li><strong>Expect <n> assertions:</strong> Along with the existing <code>expect.assertions(n)</code>, the new <code>expect.hasAssertions()</code> can be used to ensure a test has at least one assertion.</li>
<li><strong>Lint Plugin:</strong> A <code>valid-expect</code> rule was added to <code>eslint-plugin-jest</code> to ensure that an assertion is called after invoking <code>expect</code>. This will prevent mistakes like a stray <code>expect(banana);</code> with a missing assertion call.</li>
<li><strong>Pretty-Format Plugins:</strong> A number of new pretty-format plugins were added to Jest. We now pretty-print <a href="https://github.com/facebook/immutable-js/">Immutable.js</a> data structures and HtmlElements in assertion failures and snapshots.</li>
<li><strong>Custom Environment:</strong> It is now possible to add a <code>@jest-environment node|jsdom</code> annotation to the doc-block comment of a test file to use a test environment different from the default for individual tests.</li>
</ul>
<p>Here is an example of all how all the new APIs together will make testing more delightful:</p>
<pre><code>/**
 * @jest-environment node
 */

test(&#39;compares apples and bananas&#39;, async () =&gt; {
  expect.hasAssertions(); // Ensure this test has at least one assertion.

  await expect(
    Promise.resolve(Immutable.Map({apples: 1, bananas: 2})),
  ).resolves.toEqual(Immutable.Map({apples: 1, bananas: 3}));

  expect(&#39;banana&#39;); // valid-expect in eslint-plugin-jest will show an error.
});</code></pre>
<p>This example will print a test failure similar to this:</p>
<figure>
<img src="/img/blog/20-testing-apis.png" alt="testing-apis" /><figcaption>testing-apis</figcaption>
</figure>
<h2 id="breaking-changes">Breaking Changes</h2>
<p>As with every major release, we are making a number of breaking changes to make larger changes in the future possible and to push the testing experience to a new level. This time, we tried our best to only break APIs that we don’t expect to affect the majority of Jest’s users:</p>
<ul>
<li><strong>Fork of Jasmine 2.5:</strong> We finally decided to fork Jasmine itself and take ownership over Jest’s own test runner. This will allow us to improve all aspects of the unit testing experience in the future but for now we are focused on incremental rewrites and reducing the API surface. If you see a test breaking as a result of a Jasmine API that is now missing, there should be an equivalent feature on the <code>jest</code> or <code>expect</code> objects. As such, we have removed many Jasmine features that aren’t generally used in most codebases.</li>
<li><strong>New Snapshots on CI:</strong> Snapshots must always be committed along with the test and the modules they are testing. We changed Jest to not save new snapshots automatically in Continuous Integration (CI) environments or when the <code>--ci</code> flag is specified. To overwrite this behavior, which is generally not recommended, the <code>--updateSnapshot</code> flag can be used.</li>
<li><strong>Babel-Polyfill:</strong> Jest used to load <code>babel-polyfill</code> automatically when using babel-jest which resulted in memory leaks inside of Jest. In most versions of node, it is not necessary to load <code>babel-polyfill</code> so we removed this auto-inclusion and instead changed Jest to only include <code>regenerator-runtime</code> by default, which is commonly used to support async/await in older versions of Node.js. If you need <code>babel-polyfill</code>, you can manually require it in your setup files.</li>
</ul>
<h2 id="other-improvements">Other Improvements</h2>
<ul>
<li><strong>Documentation:</strong> Documentation is critical to share best practices and teach everyone how to write effective tests which will lead to better software. Over the last few weeks we have also expanded Jest’s documentation to include a Snapshot Testing FAQ, a guide with information about how to use Jest with common JavaScript libraries as well as we documented the new features mentioned above.</li>
<li><strong>Translations:</strong> We are now asking for your help to <a href="https://crowdin.com/project/jest">translate the Jest documentation</a> to make it easier for people to learn how to use Jest.</li>
<li><strong>Custom Reporters:</strong> Jest now supports custom test reporters through the <code>reporters</code> configuration option. You can finally customize the output of Jest as well as integrate it with other tools by generating reports in formats such as XML. <a href="https://jestjs.io/docs/en/configuration.html#reporters-array-modulename-modulename-options">See documentation</a>.</li>
<li><strong>Codebase Health:</strong> It was only possible iterate so quickly in Jest because we spent a significant amount of time on the health of the codebase. We were one of the early adopters of <a href="https://github.com/prettier/prettier">prettier</a>, we notably increased flow coverage, forked Jasmine to improve our test runner library and we rewrote and refactored significant portions of Jest itself to set up Jest for success in the future.</li>
<li><strong>Bugfixes:</strong> As always, we made plenty of bugfixes in Jest. The full changelog can be found in the <a href="https://github.com/facebook/jest/blob/master/CHANGELOG.md#jest-2000">Jest repository</a>.</li>
</ul>
<h2 id="talks-about-jest">Talks about Jest</h2>
<p>Recently the Jest core team and other contributors started to talk more about Jest and the experience of working on Jest at conferences:</p>
<ul>
<li>Rogelio Guzman did a talk about <a href="https://www.youtube.com/watch?time_continue=416&amp;v=HAuXJVI_bUs">Jest Snapshots and Beyond</a> at React Conf.</li>
<li>I spoke about <a href="https://developers.facebook.com/videos/f8-2017/building-high-quality-javascript-tools/">Building High-Quality JavaScript Tools</a> at Facebook’s F8 conference.</li>
</ul>
<p><em>As always, this release couldn’t have been possible without you, the JavaScript community. We are incredibly grateful that we get the opportunity to work on improving JavaScript testing together. If you’d like to contribute to Jest, please don’t hesitate to reach out to us on <a href="https://github.com/facebook/jest">GitHub</a> or on <a href="https://discord.gg/MWRhKCj">Discord</a>.</em></p>
</body>
</html>
