<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="basic-nested-forms">Basic Nested Forms</h1>
<h2 id="objectives">Objectives</h2>
<ol type="1">
<li>Construct a nested <code>params</code> hash with data about the primary object and a <code>belongs_to</code> and <code>has_many</code> association.</li>
<li>Use the conventional key names for associated data (association_attributes).</li>
<li>Name form inputs correctly to create a nested <code>params</code> hash with <code>belongs_to</code> and <code>has_many</code> associated data.</li>
<li>Define a conventional association writer for the primary model to properly instantiate associations based on the nested <code>params</code> association data.</li>
<li>Define a custom association writer for the primary model to properly instantiate associations with custom logic (like unique by name) on the nested <code>params</code> association data.</li>
<li>Use <code>fields_for</code> to generate the association fields.</li>
</ol>
<h2 id="data-model">Data model</h2>
<p>Let’s say we’re writing an address book.</p>
<p>Each <code>Person</code> can have multiple addresses. Each <code>Address</code> has a bunch of address info fields.</p>
<p>Our data model looks like this:</p>
<ul>
<li><code>Person</code>
<ul>
<li>has many <code>addresses</code></li>
<li>has a <code>name</code> (string)</li>
</ul></li>
<li><code>Address</code>
<ul>
<li>has one <code>person</code></li>
<li>has the first line of the street address stored as <code>street_address_1</code> (string)</li>
<li>has the second line of the street address stored as <code>street_address_2</code> (string)</li>
<li>has a <code>city</code> (string)</li>
<li>has a <code>state</code> (string)</li>
<li>has a <code>zipcode</code> (string)</li>
<li>has an <code>address_type</code> (string)</li>
</ul></li>
</ul>
<h2 id="creating-people">Creating people</h2>
<p>How do we write our <code>Person</code> form? We don’t want to require our user to first create an <code>Address</code>, then create that <code>Person</code>. That’s annoying. We want a single form for a <code>Person</code> containing several slots for their <code>addresses</code>.</p>
<p>Previously, we wrote setters like <code>Song#artist_name=</code> to find or create an <code>Artist</code> and connect them to the song.</p>
<p>That won’t work here, because an address contains more than one field. In the <code>Artist</code> case we were just doing the <code>name</code>. With <code>Address</code>, it’s “structured data”. All that really means is it has multiple fields attached to it. When we build a form for it, the form will send a different key for each field in each address. This can get a bit unwieldy so we generally try to group a hash within the <code>params</code> hash, which makes things much neater. Spoiler alert: Rails has a way to send this across as a hash.</p>
<p>The complete <code>params</code> object for creating a <code>Person</code> will look like the following. Using “0” and “1” as keys can seem a bit odd, but it makes everything else work moving forward. This hash is now more versatile. You can access nested values the standard way, with <code>params[:person][:addresses_attributes]["0"]</code> returning all of the information about the first address at 33 West 26th St.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" title="1">{</a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="st">:person</span> =&gt; {</a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="st">:name</span> =&gt; <span class="st">&quot;Avi&quot;</span>,</a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="st">:addresses_attributes</span> =&gt; {</a>
<a class="sourceLine" id="cb1-5" title="5">      <span class="st">&quot;0&quot;</span> =&gt; {</a>
<a class="sourceLine" id="cb1-6" title="6">        <span class="st">:street_address_1</span> =&gt; <span class="st">&quot;33 West 26th St&quot;</span>,</a>
<a class="sourceLine" id="cb1-7" title="7">        <span class="st">:street_address_2</span> =&gt; <span class="st">&quot;Apt 2B&quot;</span>,</a>
<a class="sourceLine" id="cb1-8" title="8">        <span class="st">:city</span> =&gt; <span class="st">&quot;New York&quot;</span>,</a>
<a class="sourceLine" id="cb1-9" title="9">        <span class="st">:state</span> =&gt; <span class="st">&quot;NY&quot;</span>,</a>
<a class="sourceLine" id="cb1-10" title="10">        <span class="st">:zipcode</span> =&gt; <span class="st">&quot;10010&quot;</span>,</a>
<a class="sourceLine" id="cb1-11" title="11">        <span class="st">:address_type</span> =&gt; <span class="st">&quot;Work&quot;</span></a>
<a class="sourceLine" id="cb1-12" title="12">      },</a>
<a class="sourceLine" id="cb1-13" title="13">      <span class="st">&quot;1&quot;</span> =&gt; {</a>
<a class="sourceLine" id="cb1-14" title="14">        <span class="st">:street_address_1</span> =&gt; <span class="st">&quot;11 Broadway&quot;</span>,</a>
<a class="sourceLine" id="cb1-15" title="15">        <span class="st">:street_address_2</span> =&gt; <span class="st">&quot;2nd Floor&quot;</span>,</a>
<a class="sourceLine" id="cb1-16" title="16">        <span class="st">:city</span> =&gt; <span class="st">&quot;New York&quot;</span>,</a>
<a class="sourceLine" id="cb1-17" title="17">        <span class="st">:state</span> =&gt; <span class="st">&quot;NY&quot;</span>,</a>
<a class="sourceLine" id="cb1-18" title="18">        <span class="st">:zipcode</span> =&gt; <span class="st">&quot;10004&quot;</span>,</a>
<a class="sourceLine" id="cb1-19" title="19">        <span class="st">:address_type</span> =&gt; <span class="st">&quot;Home&quot;</span></a>
<a class="sourceLine" id="cb1-20" title="20">      }</a>
<a class="sourceLine" id="cb1-21" title="21">    }</a>
<a class="sourceLine" id="cb1-22" title="22">  }</a>
<a class="sourceLine" id="cb1-23" title="23">}</a></code></pre></div>
<p>Notice the <code>addresses_attributes</code> key. That key is similar to the <code>artist_name</code> key we used previously. Last time, we handled this by writing a <code>artist_name=</code> method. In this case, we’re going to do something <em>super</em> similar. Instead of writing our own <code>addresses_attributes=</code> method, we’ll let Rails take care of it for us. We’re going to use <code>accepts_nested_attributes_for</code> and the <code>fields_for</code> FormHelper.</p>
<p>Last time, we first wrote our setter method in the model. This time let’s modify our <code>Person</code> model to include an <code>accepts_nested_attributes_for :addresses</code> line.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">class</span> <span class="dt">Person</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span></a>
<a class="sourceLine" id="cb2-2" title="2">  has_many <span class="st">:addresses</span></a>
<a class="sourceLine" id="cb2-3" title="3">  accepts_nested_attributes_for <span class="st">:addresses</span></a>
<a class="sourceLine" id="cb2-4" title="4"></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">end</span></a></code></pre></div>
<p>Now open up <code>rails c</code> and run our <code>addresses_attributes</code> method that was created for us by <code>accepts_nested_attributes_for</code>.</p>
<pre class="shell"><code>2.2.3 :018 &gt; new_person = Person.new
 =&gt; #&lt;Person id: nil, name: nil, created_at: nil, updated_at: nil&gt;

2.2.3 :019 &gt; new_person.addresses_attributes={&quot;0&quot;=&gt;{&quot;street_address_1&quot;=&gt;&quot;33 West 26&quot;, &quot;street_address_2&quot;=&gt;&quot;Floor 2&quot;, &quot;city&quot;=&gt;&quot;NYC&quot;, &quot;state&quot;=&gt;&quot;NY&quot;, &quot;zipcode&quot;=&gt;&quot;10004&quot;, &quot;address_type&quot;=&gt;&quot;work1&quot;}, &quot;1&quot;=&gt;{&quot;street_address_1&quot;=&gt;&quot;11 Broadway&quot;, &quot;street_address_2&quot;=&gt;&quot;Suite 260&quot;, &quot;city&quot;=&gt;&quot;NYC&quot;, &quot;state&quot;=&gt;&quot;NY&quot;, &quot;zipcode&quot;=&gt;&quot;10004&quot;, &quot;address_type&quot;=&gt;&quot;work2&quot;}}
 =&gt; {&quot;0&quot;=&gt;{&quot;street_address_1&quot;=&gt;&quot;33 West 26&quot;, &quot;street_address_2&quot;=&gt;&quot;Floor 2&quot;, &quot;city&quot;=&gt;&quot;NYC&quot;, &quot;state&quot;=&gt;&quot;NY&quot;, &quot;zipcode&quot;=&gt;&quot;10004&quot;, &quot;address_type&quot;=&gt;&quot;work1&quot;}, &quot;1&quot;=&gt;{&quot;street_address_1&quot;=&gt;&quot;11 Broadway&quot;, &quot;street_address_2&quot;=&gt;&quot;Suite 260&quot;, &quot;city&quot;=&gt;&quot;NYC&quot;, &quot;state&quot;=&gt;&quot;NY&quot;, &quot;zipcode&quot;=&gt;&quot;10004&quot;, &quot;address_type&quot;=&gt;&quot;work2&quot;}}

2.2.3 :020 &gt; new_person.save
   (0.2ms)  begin transaction
  SQL (0.8ms)  INSERT INTO &quot;people&quot; (&quot;created_at&quot;, &quot;updated_at&quot;) VALUES (?, ?)  [[&quot;created_at&quot;, &quot;2016-01-14 11:57:00.393038&quot;], [&quot;updated_at&quot;, &quot;2016-01-14 11:57:00.393038&quot;]]
  SQL (0.3ms)  INSERT INTO &quot;addresses&quot; (&quot;street_address_1&quot;, &quot;street_address_2&quot;, &quot;city&quot;, &quot;state&quot;, &quot;zipcode&quot;, &quot;address_type&quot;, &quot;person_id&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)  [[&quot;street_address_1&quot;, &quot;33 West 26&quot;], [&quot;street_address_2&quot;, &quot;Floor 2&quot;], [&quot;city&quot;, &quot;NYC&quot;], [&quot;state&quot;, &quot;NY&quot;], [&quot;zipcode&quot;, &quot;10004&quot;], [&quot;address_type&quot;, &quot;work1&quot;], [&quot;person_id&quot;, 3], [&quot;created_at&quot;, &quot;2016-01-14 11:57:00.403152&quot;], [&quot;updated_at&quot;, &quot;2016-01-14 11:57:00.403152&quot;]]
  SQL (0.1ms)  INSERT INTO &quot;addresses&quot; (&quot;street_address_1&quot;, &quot;street_address_2&quot;, &quot;city&quot;, &quot;state&quot;, &quot;zipcode&quot;, &quot;address_type&quot;, &quot;person_id&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)  [[&quot;street_address_1&quot;, &quot;11 Broadway&quot;], [&quot;street_address_2&quot;, &quot;Suite 260&quot;], [&quot;city&quot;, &quot;NYC&quot;], [&quot;state&quot;, &quot;NY&quot;], [&quot;zipcode&quot;, &quot;10004&quot;], [&quot;address_type&quot;, &quot;work2&quot;], [&quot;person_id&quot;, 3], [&quot;created_at&quot;, &quot;2016-01-14 11:57:00.405973&quot;], [&quot;updated_at&quot;, &quot;2016-01-14 11:57:00.405973&quot;]]
   (0.6ms)  commit transaction
 =&gt; true</code></pre>
<p>This is a bit hard to read, but you’ll notice that we have a method called <code>addresses_attributes=</code>. You didn’t write that; <code>accepts_nested_attributes_for</code> wrote that. Then when we called <code>new_person.save</code> it created both the <code>Person</code> object and the two <code>Address</code> objects. Boom!</p>
<p>Now, we just need to get our form to create a <code>params</code> hash like that. Easy Peasy. We are going to use <code>fields_for</code> to make this happen.</p>
<pre class="erb"><code># app/views/people/new.html.erb

&lt;%= form_for @person do |f| %&gt;
  &lt;%= f.label :name %&gt;
  &lt;%= f.text_field :name %&gt;&lt;br&gt;

  &lt;%= f.fields_for :addresses do |addr| %&gt;
    &lt;%= addr.label :street_address_1 %&gt;
    &lt;%= addr.text_field :street_address_1 %&gt;&lt;br&gt;

    &lt;%= addr.label :street_address_2 %&gt;
    &lt;%= addr.text_field :street_address_2 %&gt;&lt;br&gt;

    &lt;%= addr.label :city %&gt;
    &lt;%= addr.text_field :city %&gt;&lt;br&gt;

    &lt;%= addr.label :state %&gt;
    &lt;%= addr.text_field :state %&gt;&lt;br&gt;

    &lt;%= addr.label :zipcode %&gt;
    &lt;%= addr.text_field :zipcode %&gt;&lt;br&gt;

    &lt;%= addr.label :address_type %&gt;
    &lt;%= addr.text_field :address_type %&gt;&lt;br&gt;
  &lt;% end %&gt;

  &lt;%= f.submit %&gt;
&lt;% end %&gt;</code></pre>
<p>The <code>fields_for</code> line gives something nice and English-y. In that block are the fields for the addresses. Love Rails.</p>
<p>Load up the page, and see the majestic beauty of what you and Rails have written together. What?! Nothing is there.</p>
<h2 id="creating-stubs">Creating stubs</h2>
<p>We’re asking Rails to generate <code>fields_for</code> each of the <code>Person</code>’s addresses. However, when we first create a <code>Person</code>, they have no addresses. Just like <code>f.text_field :name</code> will have nothing in the text field if there is no name, <code>f.fields_for :addresses</code> will have no address fields if there are no addresses.</p>
<p>We’ll take the most straightforward way out: when we create a <code>Person</code> in the <code>PeopleController</code>, we’ll add two empty addresses to fill out. The final controller looks like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">class</span> <span class="dt">PeopleController</span> &lt; <span class="dt">ApplicationController</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="kw">def</span> new</a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="ot">@person</span> = <span class="dt">Person</span>.new</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="ot">@person</span>.addresses.build(<span class="st">address_type: &#39;work&#39;</span>)</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="ot">@person</span>.addresses.build(<span class="st">address_type: &#39;home&#39;</span>)</a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="kw">def</span> create</a>
<a class="sourceLine" id="cb5-9" title="9">    person = <span class="dt">Person</span>.create(person_params)</a>
<a class="sourceLine" id="cb5-10" title="10">    redirect_to people_path</a>
<a class="sourceLine" id="cb5-11" title="11">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb5-12" title="12"></a>
<a class="sourceLine" id="cb5-13" title="13">  <span class="kw">def</span> index</a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="ot">@people</span> = <span class="dt">Person</span>.all</a>
<a class="sourceLine" id="cb5-15" title="15">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb5-16" title="16"></a>
<a class="sourceLine" id="cb5-17" title="17">  <span class="kw">private</span></a>
<a class="sourceLine" id="cb5-18" title="18"></a>
<a class="sourceLine" id="cb5-19" title="19">  <span class="kw">def</span> person_params</a>
<a class="sourceLine" id="cb5-20" title="20">    params.require(<span class="st">:person</span>).permit(<span class="st">:name</span>)</a>
<a class="sourceLine" id="cb5-21" title="21">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb5-22" title="22"><span class="kw">end</span></a></code></pre></div>
<p>Now, refresh the page, and you’ll see two lovely address forms. Try to hit submit, and it isn’t going to work. One last hurdle. We have new <code>params</code> keys, which means we need to modify our <code>person_params</code> method to accept them. Your <code>person_params</code> method should now look like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">def</span> person_params</a>
<a class="sourceLine" id="cb6-2" title="2">  params.require(<span class="st">:person</span>).permit(</a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="st">:name</span>,</a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="st">addresses_attributes: </span>[</a>
<a class="sourceLine" id="cb6-5" title="5">      <span class="st">:street_address_1</span>,</a>
<a class="sourceLine" id="cb6-6" title="6">      <span class="st">:street_address_2</span>,</a>
<a class="sourceLine" id="cb6-7" title="7">      <span class="st">:city</span>,</a>
<a class="sourceLine" id="cb6-8" title="8">      <span class="st">:state</span>,</a>
<a class="sourceLine" id="cb6-9" title="9">      <span class="st">:zipcode</span>,</a>
<a class="sourceLine" id="cb6-10" title="10">      <span class="st">:address_type</span></a>
<a class="sourceLine" id="cb6-11" title="11">    ]</a>
<a class="sourceLine" id="cb6-12" title="12">  )</a>
<a class="sourceLine" id="cb6-13" title="13"><span class="kw">end</span></a></code></pre></div>
<h2 id="avoiding-duplicates">Avoiding duplicates</h2>
<p>One situation we can’t use <code>accepts_nested_attributes_for</code> is when we want to avoid duplicates of the row we’re creating.</p>
<p>In our address book app, perhaps it’s reasonable to have duplicate address rows. For instance, both Jerry and Tim live on 22 Elm Street, so there are two address rows for 22 Elm Street. That’s fine for those purposes.</p>
<p>But say we have a database of songs and artists. We would want <code>Artist</code> rows to be unique, so that <code>Artist.find_by(name: 'Tori Amos').songs</code> returns what we’d expect. If we want to be able to create artists <em>while</em> creating songs, we’ll need to use <code>find_or_create_by</code> in our <code>artist_attributes=</code> method:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb7-1" title="1"><span class="co"># app/models/song.rb</span></a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">class</span> <span class="dt">Song</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span></a>
<a class="sourceLine" id="cb7-4" title="4">  <span class="kw">def</span> artist_attributes=(artist)</a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="dv">self</span>.artist = <span class="dt">Artist</span>.find_or_create_by(<span class="st">name: </span>artist[<span class="st">:name</span>])</a>
<a class="sourceLine" id="cb7-6" title="6">    <span class="dv">self</span>.artist.update(artist)</a>
<a class="sourceLine" id="cb7-7" title="7">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="kw">end</span></a></code></pre></div>
<p>This looks up existing artists by name. If no matching artist is found, one is created. Then we update the artist’s attributes with the ones we were given. We could also choose to do something else if we didn’t want to allow bulk assigning of an artist’s information through a song.</p>
<p>Note that <code>accepts_nested_attributes_for</code> and setter methods (e.g., <code>artist_attributes=</code>) aren’t necessarily mutually exclusive. It’s important to evaluate the needs of your specific use case and choose the approach that makes the most sense. Keep in mind, too, that setter methods are useful for more than just avoiding duplicates –– that’s just one domain where they come in handy.</p>
<h2 id="video-review">Video Review</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=zZn0xWry6TE">Nested Forms</a></li>
</ul>
<p class="util--hide">
View <a href='https://learn.co/lessons/basic-nested-forms'>Basic Nested Forms</a> on Learn.co and start learning to code for free.
</p>
</body>
</html>
