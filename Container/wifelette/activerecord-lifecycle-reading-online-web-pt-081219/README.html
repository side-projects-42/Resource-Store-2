<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h2 id="objectives">Objectives</h2>
<ol type="1">
<li>Understand the concept of AR Lifecycle methods</li>
<li>Use <code>before_save</code>, <code>before_create</code>, and <code>before_validation</code></li>
<li>Understand when to use <code>before_validation</code> vs. <code>before_save</code></li>
</ol>
<h2 id="callbacks">Callbacks</h2>
<p>Now that you are integrating <code>ActiveRecord</code> into Rails, we must should note that we can make bits of code run whenever something happens in our model: like when it’s created (but not yet saved to the database), saved to the database, or even deleted. Everything we cover here is called “Active Record Lifecycle Callbacks”. Many people just call them callbacks. It’s a bit shorter.</p>
<p>Take a look at the blog app that is included. Be sure to run the migrations before you start learning from Rails (we do this with <code>rake db:migrate</code>)! We have a <code>Post</code> model and a few views. The <code>Post</code> <code>belongs_to</code> an <code>Author</code>.</p>
<p>Note also that in the <code>Post</code> model you’ll notice a <strong>validation</strong> to make sure that post titles are in title case. Title case means every word starts with a capital letter.</p>
<p>So, in order to make sure that our validation always passes, before every save, we want to Rails to run our title-case algorithm on the <code>title</code> of the <code>Post</code>. Let’s create the <code>make_title_case</code> method then.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># post.rb</span></a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">def</span> make_title_<span class="kw">case</span></a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="dv">self</span>.title = <span class="dv">self</span>.title.titlecase</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">end</span></a></code></pre></div>
<p>To make sure that all of our <code>Post</code>s have the correctly-formatted title, we’re going to run <code>make_title_case</code> during the first of the available lifecycle “points:” <code>before_save</code>. Our validation and lifecycle callback will make sure our posts are always title-cased.</p>
<p>We write lifecycle callbacks similarly to how you use <code>has_many</code> or <code>validates</code> and place this “hook” onto saving at the top of our model file. Since lifecycle methods run “as if by magic,” we won’t see them being called explicitly in one method by another method versus Rails running it for us, we put such statements at the top so that it catches other programmers’ eyes.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">class</span> <span class="dt">Post</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3">  belongs_to <span class="st">:author</span></a>
<a class="sourceLine" id="cb2-4" title="4">  validate <span class="st">:is_title_case</span></a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6">  <span class="co"># New Code!!</span></a>
<a class="sourceLine" id="cb2-7" title="7">  before_save <span class="st">:make_title_case</span></a>
<a class="sourceLine" id="cb2-8" title="8"></a>
<a class="sourceLine" id="cb2-9" title="9">  <span class="kw">private</span></a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="kw">def</span> is_title_<span class="kw">case</span></a>
<a class="sourceLine" id="cb2-11" title="11">    <span class="kw">if</span> title.split.any?{|w|w[<span class="dv">0</span>].upcase != w[<span class="dv">0</span>]}</a>
<a class="sourceLine" id="cb2-12" title="12">      errors.add(<span class="st">:title</span>, <span class="st">&quot;Title must be in title case&quot;</span>)</a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb2-14" title="14">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb2-15" title="15"></a>
<a class="sourceLine" id="cb2-16" title="16">  <span class="kw">def</span> make_title_<span class="kw">case</span></a>
<a class="sourceLine" id="cb2-17" title="17">    <span class="co"># Rails provides a String#titlecase method</span></a>
<a class="sourceLine" id="cb2-18" title="18">    <span class="dv">self</span>.title = <span class="dv">self</span>.title.titlecase</a>
<a class="sourceLine" id="cb2-19" title="19">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb2-20" title="20"><span class="kw">end</span></a></code></pre></div>
<p>We’d expect that whenever Rails persists <code>Post</code> models to the database, (so <code>#save</code> and <code>#create</code>) this code will get run. Let’s open up the console (<code>rails c</code>) and test it out:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb3-1" title="1">p = <span class="dt">Post</span>.create(<span class="st">title: &quot;testing&quot;</span>)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co">#   (0.1ms)  begin transaction</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co">#   (0.1ms)  rollback transaction</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co"># =&gt; #&lt;Post id: nil, title: &quot;testing&quot;, description: nil, created_at: nil, updated_at: nil, post_status: nil, author_id: nil&gt;</span></a></code></pre></div>
<p>Wait! There was no <code>INSERT</code> SQL command issued. In fact, we see the <code>rollback transaction</code> line. That means that it didn’t actually save to the database. If we do <code>p.valid?</code> right now it will return <code>false</code>.</p>
<p>This feels surprising. Most of the time when we have this feeling while programming it’s because we didn’t understand something subtle. This is true here.</p>
<p>It turns out that the <code>before_save</code> is called <strong>after</strong> validation occurs. So Rails goes <code>is valid?</code> “Nope! Stop!”, and never makes it to <code>before_save</code>. We missed that subtlety.</p>
<p>Let’s change our callback to the <code>before_validation</code> callback. This one happens <strong>before</strong> validation. That means that first our <code>before_validation</code> code works, which title cases the title, <em>then</em> the validation runs, which passes! Here is the final code:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">class</span> <span class="dt">Post</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span></a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3">  belongs_to <span class="st">:author</span></a>
<a class="sourceLine" id="cb4-4" title="4">  validate <span class="st">:is_title_case</span></a>
<a class="sourceLine" id="cb4-5" title="5"></a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="co"># New Code!!</span></a>
<a class="sourceLine" id="cb4-7" title="7">  before_validation <span class="st">:make_title_case</span></a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="kw">private</span></a>
<a class="sourceLine" id="cb4-10" title="10"></a>
<a class="sourceLine" id="cb4-11" title="11">  <span class="kw">def</span> is_title_<span class="kw">case</span></a>
<a class="sourceLine" id="cb4-12" title="12">    <span class="kw">if</span> title.split.any?{|w|w[<span class="dv">0</span>].upcase != w[<span class="dv">0</span>]}</a>
<a class="sourceLine" id="cb4-13" title="13">      errors.add(<span class="st">:title</span>, <span class="st">&quot;Title must be in title case&quot;</span>)</a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb4-15" title="15">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb4-16" title="16"></a>
<a class="sourceLine" id="cb4-17" title="17">  <span class="kw">def</span> make_title_<span class="kw">case</span></a>
<a class="sourceLine" id="cb4-18" title="18">    <span class="dv">self</span>.title = <span class="dv">self</span>.title.titlecase</a>
<a class="sourceLine" id="cb4-19" title="19">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="kw">end</span></a></code></pre></div>
<p>Here is a rule of thumb: <strong>Whenever you are modifying an attribute of the model, use <code>before_validation</code>. If you are doing some other action, then use <code>before_save</code>.</strong></p>
<h3 id="before-save">Before Save</h3>
<p>Now let’s do something that (properly) belongs in the <code>before_save</code>. We use <code>before_save</code> for actions that need to occur that aren’t modifying the model itself. For example, whenever you save to the database, let’s send an email to the <code>Author</code> alerting them that the post was just saved!</p>
<p>This is a perfect <code>before_save</code> action. It doesn’t modify the model so there is no validation weirdness, and we don’t want to email the user if the Post is invalid. That would be just mean! So if you had some method called <code>email_author_about_post</code> you would modify your <code>Post</code> model to look like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">class</span> <span class="dt">Post</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span></a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3">  belongs_to <span class="st">:author</span></a>
<a class="sourceLine" id="cb5-4" title="4">  validate <span class="st">:is_title_case</span></a>
<a class="sourceLine" id="cb5-5" title="5"></a>
<a class="sourceLine" id="cb5-6" title="6">  before_validation <span class="st">:make_title_case</span></a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="co"># New Code!!</span></a>
<a class="sourceLine" id="cb5-9" title="9">  before_save <span class="st">:email_author_about_post</span></a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11">  <span class="kw">private</span></a>
<a class="sourceLine" id="cb5-12" title="12"></a>
<a class="sourceLine" id="cb5-13" title="13">  <span class="kw">def</span> is_title_<span class="kw">case</span></a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="kw">if</span> title.split.any?{|w|w[<span class="dv">0</span>].upcase != w[<span class="dv">0</span>]}</a>
<a class="sourceLine" id="cb5-15" title="15">      errors.add(<span class="st">:title</span>, <span class="st">&quot;Title must be in title case&quot;</span>)</a>
<a class="sourceLine" id="cb5-16" title="16">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb5-17" title="17">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb5-18" title="18"></a>
<a class="sourceLine" id="cb5-19" title="19">  <span class="kw">def</span> email_author_about_post</a>
<a class="sourceLine" id="cb5-20" title="20">    <span class="co"># Not implemented.</span></a>
<a class="sourceLine" id="cb5-21" title="21">    <span class="co"># For more information: https://guides.rubyonrails.org/action_mailer_basics.html</span></a>
<a class="sourceLine" id="cb5-22" title="22">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb5-23" title="23"></a>
<a class="sourceLine" id="cb5-24" title="24">  <span class="kw">def</span> make_title_<span class="kw">case</span></a>
<a class="sourceLine" id="cb5-25" title="25">    <span class="dv">self</span>.title = <span class="dv">self</span>.title.titlecase</a>
<a class="sourceLine" id="cb5-26" title="26">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb5-27" title="27"><span class="kw">end</span></a></code></pre></div>
<h3 id="before-create">Before Create</h3>
<p>Before you move on, let’s cover one last callback that is useful: <code>before_create</code>. <code>before_create</code> is very close to <code>before_save</code> with one major difference: it only gets called when a model is created for the first time. This means not every time the object is persisted, just when it is <strong>new</strong>.</p>
<p>For more information on all of the callbacks available to you, check out <a href="http://guides.rubyonrails.org/active_record_callbacks.html">this amazing rails guide</a></p>
<p class="util--hide">
View <a href='https://learn.co/lessons/activerecord-lifecycle-reading'>ActiveRecord Lifecycle Methods</a> on Learn.co and start learning to code for free.
</p>
</body>
</html>
