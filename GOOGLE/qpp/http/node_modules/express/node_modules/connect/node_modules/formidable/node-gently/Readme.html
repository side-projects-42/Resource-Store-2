<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Readme</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<h1 id="gently">Gently</h1>
<h2 id="purpose">Purpose</h2>
<p>A node.js module that helps with stubbing and behavior verification. It allows you to test the most remote and nested corners of your code while keeping being fully unobtrusive.</p>
<h2 id="features">Features</h2>
<ul>
<li>Overwrite and stub individual object functions</li>
<li>Verify that all expected calls have been made in the expected order</li>
<li>Restore stubbed functions to their original behavior</li>
<li>Detect object / class names from obj.constructor.name and obj.toString()</li>
<li>Hijack any required module function or class constructor</li>
</ul>
<h2 id="installation">Installation</h2>
<p>Via <a href="http://github.com/isaacs/npm">npm</a>:</p>
<pre><code>npm install gently@latest</code></pre>
<h2 id="example">Example</h2>
<p>Make sure your dog is working properly:</p>
<pre><code>function Dog() {}

Dog.prototype.seeCat = function() {
  this.bark(&#39;whuf, whuf&#39;);
  this.run();
}

Dog.prototype.bark = function(bark) {
  require(&#39;sys&#39;).puts(bark);
}

var gently = new (require(&#39;gently&#39;))
  , assert = require(&#39;assert&#39;)
  , dog = new Dog();

gently.expect(dog, &#39;bark&#39;, function(bark) {
  assert.equal(bark, &#39;whuf, whuf&#39;);
});
gently.expect(dog, &#39;run&#39;);

dog.seeCat();</code></pre>
<p>You can also easily test event emitters with this, for example a simple sequence of 2 events emitted by <code>fs.WriteStream</code>:</p>
<pre><code>var gently = new (require(&#39;gently&#39;))
  , stream = new (require(&#39;fs&#39;).WriteStream)(&#39;my_file.txt&#39;);

gently.expect(stream, &#39;emit&#39;, function(event) {
  assert.equal(event, &#39;open&#39;);
});

gently.expect(stream, &#39;emit&#39;, function(event) {
  assert.equal(event, &#39;drain&#39;);
});</code></pre>
<p>For a full read world example, check out this test case: <a href="http://github.com/felixge/node-formidable/blob/master/test/simple/test-incoming-form.js">test-incoming-form.js</a> (in <a href="http://github.com/felixge/node-formidable">node-formdiable</a>).</p>
<h2 id="api">API</h2>
<h3 id="gently-1">Gently</h3>
<h4 id="new-gently">new Gently()</h4>
<p>Creates a new gently instance. It listens to the process <code>'exit'</code> event to make sure all expectations have been verified.</p>
<h4 id="gently.expectobj-method-count-stubfn">gently.expect(obj, method, [[count], stubFn])</h4>
<p>Creates an expectation for an objects method to be called. You can optionally specify the call <code>count</code> you are expecting, as well as <code>stubFn</code> function that will run instead of the original function.</p>
<p>Returns a reference to the function that is getting overwritten.</p>
<h4 id="gently.expectcount-stubfn">gently.expect([count], stubFn)</h4>
<p>Returns a function that is supposed to be executed <code>count</code> times, delegating any calls to the provided <code>stubFn</code> function. Naming your stubFn closure will help to properly diagnose errors that are being thrown:</p>
<pre><code>childProcess.exec(&#39;ls&#39;, gently.expect(function lsCallback(code) {
  assert.equal(0, code);
}));</code></pre>
<h4 id="gently.restoreobj-method">gently.restore(obj, method)</h4>
<p>Restores an object method that has been previously overwritten using <code>gently.expect()</code>.</p>
<h4 id="gently.hijackrealrequire">gently.hijack(realRequire)</h4>
<p>Returns a new require functions that catches a reference to all required modules into <code>gently.hijacked</code>.</p>
<p>To use this function, include a line like this in your <code>'my-module.js'</code>.</p>
<pre><code>if (global.GENTLY) require = GENTLY.hijack(require);

var sys = require(&#39;sys&#39;);
exports.hello = function() {
  sys.log(&#39;world&#39;);
};</code></pre>
<p>Now you can write a test for the module above:</p>
<pre><code>var gently = global.GENTLY = new (require(&#39;gently&#39;))
  , myModule = require(&#39;./my-module&#39;);

gently.expect(gently.hijacked.sys, &#39;log&#39;, function(str) {
  assert.equal(str, &#39;world&#39;);
});

myModule.hello();</code></pre>
<h4 id="gently.stublocation-exportsname">gently.stub(location, [exportsName])</h4>
<p>Returns a stub class that will be used instead of the real class from the module at <code>location</code> with the given <code>exportsName</code>.</p>
<p>This allows to test an OOP version of the previous example, where <code>'my-module.js'</code>.</p>
<pre><code>if (global.GENTLY) require = GENTLY.hijack(require);

var World = require(&#39;./world&#39;);

exports.hello = function() {
  var world = new World();
  world.hello();
}</code></pre>
<p>And <code>world.js</code> looks like this:</p>
<pre><code>var sys = require(&#39;sys&#39;);

function World() {

}
module.exports = World;

World.prototype.hello = function() {
  sys.log(&#39;world&#39;);
};</code></pre>
<p>Testing <code>'my-module.js'</code> can now easily be accomplished:</p>
<pre><code>var gently = global.GENTLY = new (require(&#39;gently&#39;))
  , WorldStub = gently.stub(&#39;./world&#39;)
  , myModule = require(&#39;./my-module&#39;)
  , WORLD;

gently.expect(WorldStub, &#39;new&#39;, function() {
  WORLD = this;
});

gently.expect(WORLD, &#39;hello&#39;);

myModule.hello();</code></pre>
<h4 id="gently.hijacked">gently.hijacked</h4>
<p>An object that holds the references to all hijacked modules.</p>
<h4 id="gently.verifymsg">gently.verify([msg])</h4>
<p>Verifies that all expectations of this gently instance have been satisfied. If not called manually, this method is called when the process <code>'exit'</code> event is fired.</p>
<p>If <code>msg</code> is given, it will appear in any error that might be thrown.</p>
<h2 id="license">License</h2>
<p>Gently is licensed under the MIT license.</p>
</body>
</html>
